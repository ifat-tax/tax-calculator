<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××—×©×‘×•×Ÿ ××¡ ×•××¢"× ××ª×§×“×</title>
    
    <!-- PWA Configuration -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1a365d">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="××—×©×‘×•×Ÿ ××¡">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'%3E%3Crect fill='%231a365d' width='192' height='192' rx='24'/%3E%3Ctext x='96' y='130' font-size='100' text-anchor='middle' fill='white'%3EğŸ“Š%3C/text%3E%3C/svg%3E">
    
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #1a365d; --accent: #f59e0b; --success: #10b981;
            --bg-card: #ffffff; --text-primary: #1e293b;
        }
        body {
            font-family: 'Assistant', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; padding: 2rem 1rem;
        }
        .container { max-width: 1600px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 2rem; color: white; }
        .header h1 { font-size: 2.5rem; font-weight: 800; margin-bottom: 0.5rem; }
        .card {
            background: white; border-radius: 16px; padding: 2rem;
            margin-bottom: 2rem; box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }
        .card-title {
            font-size: 1.5rem; font-weight: 700; margin-bottom: 1.5rem;
            color: var(--primary); border-bottom: 3px solid var(--accent); padding-bottom: 0.5rem;
        }
        .settings-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
        .setting-item { background: #f8fafc; padding: 1rem; border-radius: 8px; }
        .setting-item label { display: block; font-weight: 600; margin-bottom: 0.5rem; font-size: 0.9rem; }
        .setting-item input {
            width: 100%; padding: 0.5rem; border: 2px solid #e2e8f0; border-radius: 6px;
            font-size: 1rem; text-align: center;
            transition: all 0.2s;
        }
        
        .setting-item input:focus {
            outline: none;
            border-color: #f59e0b;
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.2);
            background: #fffbeb;
        }
        
        .setting-item input:hover {
            border-color: #fbbf24;
        }
        .helper-text { font-size: 0.75rem; color: #64748b; margin-top: 0.25rem; }
        
        .category-total {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            align-items: center;
            padding: 0.75rem 1rem;
            background: linear-gradient(135deg, #1a365d 0%, #2d4a7c 100%);
            border-radius: 6px;
            margin-top: 0.5rem;
            margin-bottom: 1rem;
            color: white;
            font-size: 0.85rem;
            gap: 0.5rem;
        }
        
        .category-total-label { font-weight: 700; font-size: 0.9rem; }
        
        .category-total-col {
            text-align: center;
        }
        
        .category-total-col-label {
            font-size: 0.7rem;
            opacity: 0.8;
            margin-bottom: 0.15rem;
        }
        
        .category-total-col-value {
            font-weight: 700;
            font-size: 0.95rem;
        }
        
        .period-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.75rem; }
        .period-btn {
            padding: 1rem; background: #f8fafc; border: 2px solid #e2e8f0;
            border-radius: 8px; cursor: pointer; text-align: center; font-weight: 600;
        }
        .period-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        
        .main-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; }
        .input-group { margin-bottom: 0.75rem; }
        .input-group label { display: block; font-weight: 600; margin-bottom: 0.25rem; font-size: 0.9rem; }
        .input-group input {
            width: 100%; padding: 0.5rem; border: 2px solid #e2e8f0;
            border-radius: 6px; font-size: 0.95rem;
        }
        
        .collapse-header {
            background: #f8fafc; padding: 0.75rem; border-radius: 6px;
            cursor: pointer; font-weight: 600; margin-bottom: 0.5rem;
        }
        .collapse-content { max-height: 0; overflow: hidden; transition: max-height 0.3s; }
        .collapse-content.active { max-height: 1500px; padding-top: 0.5rem; }
        
        .btn-calculate {
            width: 100%; padding: 1rem; background: linear-gradient(135deg, var(--accent) 0%, #ea580c 100%);
            color: white; border: none; border-radius: 12px; font-size: 1.1rem;
            font-weight: 700; cursor: pointer; margin-top: 1rem;
        }
        
        .btn-calculate:disabled {
            background: linear-gradient(135deg, #94a3b8 0%, #64748b 100%);
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .btn-freeze {
            width: 100%; padding: 1rem; background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
            color: white; border: none; border-radius: 12px; font-size: 1.1rem;
            font-weight: 700; cursor: pointer; margin-top: 1rem;
        }
        
        .btn-freeze:disabled {
            background: linear-gradient(135deg, #94a3b8 0%, #64748b 100%);
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .tabs-header { display: flex; background: #f8fafc; border-bottom: 3px solid #e2e8f0; }
        .tab-button {
            flex: 1; padding: 1rem; background: transparent; border: none;
            cursor: pointer; font-size: 1.1rem; font-weight: 700; color: #64748b;
        }
        .tab-button.active { color: var(--primary); background: white; }
        .tab-content { display: none; padding: 2rem; }
        .tab-content.active { display: block; }
        
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin: 1rem 0; }
        .summary-box {
            background: linear-gradient(135deg, var(--primary) 0%, #2d4a7c 100%);
            padding: 1.5rem; border-radius: 12px; text-align: center; color: white;
        }
        .summary-box-label { font-size: 0.9rem; opacity: 0.9; margin-bottom: 0.5rem; }
        .summary-box-value { font-size: 2rem; font-weight: 800; }
        .summary-box.success { background: linear-gradient(135deg, var(--success) 0%, #059669 100%); }
        .summary-box.warning { background: linear-gradient(135deg, var(--accent) 0%, #ea580c 100%); }
        
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        th { background: var(--primary); color: white; padding: 0.75rem; text-align: right; font-size: 0.85rem; }
        td { padding: 0.5rem 0.75rem; border-bottom: 1px solid #e2e8f0; text-align: right; font-size: 0.85rem; }
        .total-row { background: #f8fafc; font-weight: 700; }
        
        @media (max-width: 968px) { .main-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š ××—×©×‘×•×Ÿ ××¡ ×•××¢"× ××ª×§×“×</h1>
            <p>× ×™×”×•×œ ×›×¡×¤×™ ××§×¦×•×¢×™ ×¢× ×—×™×©×•×‘×™ ××¡ ××œ××™×</p>
            <div style="display:flex;gap:1rem;justify-content:center;margin-top:1rem;flex-wrap:wrap;">
                <button onclick="openUploadModal()" style="padding:0.75rem 2rem;background:linear-gradient(135deg,#10b981,#059669);color:white;border:none;border-radius:10px;font-size:1.1rem;font-weight:700;cursor:pointer;box-shadow:0 4px 15px rgba(16,185,129,0.4);">
                    ğŸ“¤ ×”×¢×œ××ª ×—×©×‘×•× ×™×•×ª
                </button>
                <button id="gdriveSyncBtn" onclick="toggleGoogleDriveSync()" style="padding:0.75rem 2rem;background:linear-gradient(135deg,#3b82f6,#1d4ed8);color:white;border:none;border-radius:10px;font-size:1.1rem;font-weight:700;cursor:pointer;box-shadow:0 4px 15px rgba(59,130,246,0.4);">
                    <span id="gdriveIcon">â˜ï¸</span> ×¡× ×›×¨×•×Ÿ Google Drive
                </button>
            </div>
            <div id="gdriveSyncStatus" style="margin-top:0.5rem;font-size:0.85rem;color:rgba(255,255,255,0.9);display:none;"></div>
        </div>

        <!-- Upload Modal -->
        <div id="uploadModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:1000;overflow-y:auto;">
            <div style="background:white;max-width:700px;margin:2rem auto;border-radius:16px;overflow:hidden;box-shadow:0 25px 60px rgba(0,0,0,0.3);">
                <!-- Modal Header -->
                <div style="background:linear-gradient(135deg,#1a365d,#2d4a7c);padding:1.5rem;display:flex;justify-content:space-between;align-items:center;">
                    <div>
                        <h2 style="color:white;margin:0;font-size:1.3rem;">ğŸ“¤ ×”×¢×œ××ª ×—×©×‘×•× ×™×•×ª</h2>
                        <p style="color:rgba(255,255,255,0.7);margin:0.25rem 0 0;font-size:0.85rem;">×’×¨×•×¨ ×§×‘×¦×™× ××• ×œ×—×¥ ×œ×‘×—×™×¨×” â€” Claude ×™×¡×•×•×’ ××•×˜×•××˜×™×ª</p>
                    </div>
                    <button onclick="closeUploadModal()" style="background:rgba(255,255,255,0.15);border:none;color:white;width:36px;height:36px;border-radius:50%;font-size:1.2rem;cursor:pointer;">âœ•</button>
                </div>

                <!-- Period selector inside modal -->
                <div style="padding:1rem 1.5rem;background:#f8fafc;border-bottom:1px solid #e2e8f0;">
                    <label style="font-weight:700;color:#1a365d;font-size:0.9rem;">ğŸ“… ×ª×§×•×¤×” ×œ×™×™×—×•×¡ ×”×—×©×‘×•× ×™×•×ª:</label>
                    <select id="uploadPeriodSelect" style="width:100%;margin-top:0.4rem;padding:0.5rem;border:2px solid #e2e8f0;border-radius:8px;font-size:0.95rem;">
                        <option value="">-- ×‘×—×¨ ×ª×§×•×¤×” --</option>
                        <option value="1">×™× ×•××¨-×¤×‘×¨×•××¨</option>
                        <option value="2">××¨×¥-××¤×¨×™×œ</option>
                        <option value="3">×××™-×™×•× ×™</option>
                        <option value="4">×™×•×œ×™-××•×’×•×¡×˜</option>
                        <option value="5">×¡×¤×˜××‘×¨-××•×§×˜×•×‘×¨</option>
                        <option value="6">× ×•×‘××‘×¨-×“×¦××‘×¨</option>
                    </select>
                </div>

                <!-- Drop Zone -->
                <div id="dropZone" style="margin:1.5rem;border:3px dashed #cbd5e1;border-radius:12px;padding:2.5rem;text-align:center;cursor:pointer;transition:all 0.2s;"
                    onclick="document.getElementById('folderInput').click()"
                    ondragover="event.preventDefault();this.style.borderColor='#3b82f6';this.style.background='#eff6ff';"
                    ondragleave="this.style.borderColor='#cbd5e1';this.style.background='';"
                    ondrop="handleFolderDrop(event)">
                    <div style="font-size:3rem;margin-bottom:0.75rem;">ğŸ“</div>
                    <p style="font-size:1.1rem;font-weight:700;color:#1a365d;margin:0;">×’×¨×•×¨ ×ª×™×§×™×™×ª ×—×•×“×© ×œ×›××Ÿ</p>
                    <p style="color:#64748b;margin:0.25rem 0 0;font-size:0.85rem;">×”××‘× ×”: [×—×•×“×©]/[×§×˜×’×•×¨×™×”]/[×§×‘×¦×™×]</p>
                    <p style="color:#94a3b8;margin:0.5rem 0 0;font-size:0.75rem;">×“×•×’××”: ×™× ×•××¨-×¤×‘×¨×•××¨/×“×œ×§/×—×©×‘×•× ×™×ª1.pdf</p>
                    <input type="file" id="folderInput" webkitdirectory directory multiple style="display:none" onchange="handleFolderSelect(this.files)">
                </div>

                <!-- File List -->
                <div id="fileList" style="padding:0 1.5rem;max-height:250px;overflow-y:auto;display:none;">
                    <div id="fileItems"></div>
                </div>

                <!-- Process Button -->
                <div style="padding:1rem 1.5rem;display:flex;gap:1rem;justify-content:flex-end;border-top:1px solid #e2e8f0;">
                    <button onclick="closeUploadModal()" style="padding:0.6rem 1.5rem;background:#f1f5f9;border:none;border-radius:8px;font-weight:600;cursor:pointer;color:#64748b;">×‘×™×˜×•×œ</button>
                    <button id="processBtn" onclick="processInvoices()" style="padding:0.6rem 1.5rem;background:linear-gradient(135deg,#3b82f6,#1d4ed8);color:white;border:none;border-radius:8px;font-weight:700;cursor:pointer;opacity:0.4;" disabled>
                        ğŸ¤– ×¢×‘×“ ×—×©×‘×•× ×™×•×ª ×¢× AI
                    </button>
                </div>

                <!-- Results Area -->
                <div id="resultsArea" style="display:none;padding:1.5rem;border-top:2px solid #e2e8f0;">
                    <h3 style="color:#1a365d;margin:0 0 1rem;font-size:1rem;">ğŸ“Š ×ª×•×¦××•×ª ×¡×™×•×•×’:</h3>
                    <div id="resultsContent"></div>
                    <!-- Manual entry for unreadable -->
                    <div id="manualArea" style="display:none;margin-top:1rem;">
                        <div style="background:#fef3c7;border:2px solid #f59e0b;border-radius:8px;padding:1rem;">
                            <h4 style="color:#92400e;margin:0 0 0.75rem;">âš ï¸ ×—×©×‘×•× ×™×•×ª ×©×œ× × ×™×ª×Ÿ ×œ×§×¨×•× â€” ×”×–×Ÿ ×™×“× ×™×ª:</h4>
                            <div id="manualItems"></div>
                        </div>
                    </div>
                    <button id="applyBtn" onclick="applyResults()" style="margin-top:1rem;width:100%;padding:0.75rem;background:linear-gradient(135deg,#10b981,#059669);color:white;border:none;border-radius:8px;font-weight:700;font-size:1rem;cursor:pointer;">
                        âœ… ×”×—×œ × ×ª×•× ×™× ×¢×œ ×”×˜×•×¤×¡
                    </button>
                </div>
            </div>
        </div>

        <!-- Settings -->
        <div class="card">
            <h2 class="card-title">âš™ï¸ ×”×’×“×¨×•×ª</h2>
            <div class="settings-grid">
                <div class="setting-item">
                    <label>××¢"× (%)</label>
                    <input type="number" id="vatRate" value="18" step="0.1" readonly style="background:#f1f5f9;cursor:not-allowed;">
                    <div class="helper-text">×©×™×¢×•×¨ ×”××¢"× ×”× ×•×›×—×™</div>
                </div>
                <div class="setting-item">
                    <label>××—×•×– ××§×“××•×ª ××¡ (%)</label>
                    <input type="number" id="advanceTaxPercent" value="6" step="0.1" readonly style="background:#f1f5f9;cursor:not-allowed;">
                    <div class="helper-text">××—×•×– ××§×“××•×ª ××¨×•×•×—×™×•×ª (×œ×“×•×’××”: 20 = 20%)</div>
                </div>
                <div class="setting-item">
                    <label>××—×•×– ×©×™××•×© ×¢×¡×§×™ ×‘×“×™×¨×” (%)</label>
                    <input type="number" id="homeOfficePercent" value="20" step="1" readonly style="background:#f1f5f9;cursor:not-allowed;">
                    <div class="helper-text">×—×œ×§ ×¢×¡×§×™ ××”×•×¦××•×ª ×”×“×™×¨×” (×‘×¨×™×¨×ª ××—×“×œ: 20%)</div>
                </div>
            </div>
            <div style="margin-top: 1rem; display: flex; gap: 1rem;">
                <button id="editSettingsBtn" onclick="startEditSettings()" style="padding:0.6rem 1.5rem;background:linear-gradient(135deg,#f59e0b,#ea580c);color:white;border:none;border-radius:8px;font-size:1rem;font-weight:700;cursor:pointer;">
                    âœï¸ ×¢×¨×•×š ×”×’×“×¨×•×ª
                </button>
                <button id="saveSettingsBtn" onclick="saveSettings()" style="display:none;padding:0.6rem 1.5rem;background:linear-gradient(135deg,#10b981,#059669);color:white;border:none;border-radius:8px;font-size:1rem;font-weight:700;cursor:pointer;">
                    âœ… ×©××•×¨ ×©×™× ×•×™×™×
                </button>
                <button id="cancelSettingsBtn" onclick="cancelSettings()" style="display:none;padding:0.6rem 1.5rem;background:#64748b;color:white;border:none;border-radius:8px;font-size:1rem;font-weight:700;cursor:pointer;">
                    âŒ ×‘×™×˜×•×œ
                </button>
            </div>
        </div>

        <!-- Period Selector -->
        <div class="card">
            <h2 class="card-title">ğŸ“… ×‘×—×¨ ×ª×§×•×¤×”</h2>
            <div class="period-grid">
                <div class="period-btn" onclick="selectPeriod(1, '×™× ×•××¨-×¤×‘×¨×•××¨')">×™× ×•-×¤×‘×¨</div>
                <div class="period-btn" onclick="selectPeriod(2, '××¨×¥-××¤×¨×™×œ')">××¨×¥-××¤×¨</div>
                <div class="period-btn" onclick="selectPeriod(3, '×××™-×™×•× ×™')">×××™-×™×•× ×™</div>
                <div class="period-btn" onclick="selectPeriod(4, '×™×•×œ×™-××•×’×•×¡×˜')">×™×•×œ-××•×’</div>
                <div class="period-btn" onclick="selectPeriod(5, '×¡×¤×˜××‘×¨-××•×§×˜×•×‘×¨')">×¡×¤×˜-××•×§</div>
                <div class="period-btn" onclick="selectPeriod(6, '× ×•×‘××‘×¨-×“×¦××‘×¨')">× ×•×‘-×“×¦×</div>
            </div>
        </div>

        <!-- Input Form -->
        <div class="main-grid">
            <div class="card">
                <h2 class="card-title">ğŸ’° ×”×›× ×¡×•×ª</h2>
                <div id="selectedPeriodIndicator" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; color: white; font-weight: 600; text-align: center; display: none;">
                    ğŸ“… ×ª×§×•×¤×” × ×‘×—×¨×ª: <span id="selectedPeriodName"></span>
                </div>
                <div class="input-group">
                    <label>×¡×”"×› ×”×›× ×¡×•×ª (×›×•×œ×œ ××¢"×)</label>
                    <input type="number" id="totalIncome" placeholder="0" step="0.01" oninput="calculate()" disabled>
                </div>
                <div class="category-total" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                    <span class="category-total-label">ğŸ’° ×¡×™×›×•× ×”×›× ×¡×•×ª</span>
                    <div class="category-total-col">
                        <div class="category-total-col-label">×¡×”"×›</div>
                        <div class="category-total-col-value" id="inc-total">â‚ª0</div>
                    </div>
                    <div class="category-total-col">
                        <div class="category-total-col-label">×œ×œ× ××¢"×</div>
                        <div class="category-total-col-value" id="inc-net">â‚ª0</div>
                    </div>
                    <div class="category-total-col">
                        <div class="category-total-col-label">××¢"×</div>
                        <div class="category-total-col-value" id="inc-vat">â‚ª0</div>
                    </div>
                </div>
                <div class="info-box" id="noPeriodWarning" style="background: #fef3c7; border-color: #f59e0b; color: #92400e;">
                    <strong>âš ï¸ ×©×™× ×œ×‘:</strong> ×™×© ×œ×‘×—×•×¨ ×ª×§×•×¤×ª ×“×™×•×•×— ×œ×¤× ×™ ×”×–× ×ª × ×ª×•× ×™×
                </div>
            </div>

            <div class="card">
                <h2 class="card-title">ğŸ’³ ×”×•×¦××•×ª</h2>
                <div class="collapse-header" onclick="toggle('transport')">ğŸš— ×ª×—×‘×•×¨×”</div>
                <div class="collapse-content" id="transport">
                    <div class="input-group">
                        <label>××•× ×™×•×ª</label>
                        <input type="number" class="exp" disabled data-cat="××•× ×™×•×ª" placeholder="0" step="0.01" oninput="calculate()">
                    </div>
                    <div class="input-group">
                        <label>×—× ×™×•×ª</label>
                        <input type="number" class="exp" disabled data-cat="×—× ×™×”" placeholder="0" step="0.01" oninput="calculate()">
                    </div>
                    <div class="input-group">
                        <label>×—× ×™×” (××¢"× ××¤×¡)</label>
                        <input type="number" class="exp" disabled data-cat="×—× ×™×” ××¢×´× ××¤×¡" data-novat="true" placeholder="0" step="0.01" oninput="calculate()">
                    </div>
                    <div class="category-total">
                        <span class="category-total-label">ğŸš— ×¡×”"×› ×ª×—×‘×•×¨×”</span>
                        <div class="category-total-col">
                            <div class="category-total-col-label">×¡×”"×›</div>
                            <div class="category-total-col-value" id="total-transport">â‚ª0</div>
                        </div>
                        <div class="category-total-col">
                            <div class="category-total-col-label">×œ×œ× ××¢"×</div>
                            <div class="category-total-col-value" id="total-transport-net">â‚ª0</div>
                        </div>
                        <div class="category-total-col">
                            <div class="category-total-col-label">××¢"×</div>
                            <div class="category-total-col-value" id="total-transport-vat">â‚ª0</div>
                        </div>
                    </div>
                </div>

                <div class="collapse-header" onclick="toggle('office')">ğŸ¢ ××©×¨×“</div>
                <div class="collapse-content" id="office">
                    <div class="input-group">
                        <label>×”×•×¦××•×ª ××©×¨×“</label>
                        <input type="number" class="exp" disabled data-cat="××©×¨×“×™" placeholder="0" step="0.01" oninput="calculate()">
                    </div>
                    <div class="input-group">
                        <label>× ×™×”×•×œ ×™×•××Ÿ ×¤×¡×™×›×•×œ×•×’</label>
                        <input type="number" class="exp" disabled data-cat="× ×™×”×•×œ ×™×•××Ÿ ×¤×¡×™×›×•×œ×•×’" placeholder="0" step="0.01" oninput="calculate()">
                    </div>
                    <div class="category-total">
                        <span class="category-total-label">ğŸ¢ ×¡×”"×› ××©×¨×“</span>
                        <div class="category-total-col">
                            <div class="category-total-col-label">×¡×”"×›</div>
                            <div class="category-total-col-value" id="total-office">â‚ª0</div>
                        </div>
                        <div class="category-total-col">
                            <div class="category-total-col-label">×œ×œ× ××¢"×</div>
                            <div class="category-total-col-value" id="total-office-net">â‚ª0</div>
                        </div>
                        <div class="category-total-col">
                            <div class="category-total-col-label">××¢"×</div>
                            <div class="category-total-col-value" id="total-office-vat">â‚ª0</div>
                        </div>
                    </div>
                </div>

                <div class="collapse-header" onclick="toggle('equipment')">ğŸ–¥ï¸ ×¦×™×•×“ ××©×¨×“×™</div>
                <div class="collapse-content" id="equipment">
                    <div class="input-group">
                        <label>×¦×™×•×“ ××©×¨×“×™</label>
                        <input type="number" class="exp" disabled data-cat="×¦×™×•×“ ××©×¨×“×™" placeholder="0" step="0.01" oninput="calculate()">
                    </div>
                    <div class="category-total">
                        <span class="category-total-label">ğŸ–¥ï¸ ×¡×”"×› ×¦×™×•×“ ××©×¨×“×™</span>
                        <div class="category-total-col">
                            <div class="category-total-col-label">×¡×”"×›</div>
                            <div class="category-total-col-value" id="total-equipment">â‚ª0</div>
                        </div>
                        <div class="category-total-col">
                            <div class="category-total-col-label">×œ×œ× ××¢"×</div>
                            <div class="category-total-col-value" id="total-equipment-net">â‚ª0</div>
                        </div>
                        <div class="category-total-col">
                            <div class="category-total-col-label">××¢"×</div>
                            <div class="category-total-col-value" id="total-equipment-vat">â‚ª0</div>
                        </div>
                    </div>
                </div>

                <div class="collapse-header" onclick="toggle('vehicle')">ğŸš™ ×¨×›×‘</div>
                <div class="collapse-content" id="vehicle">
                    <div class="input-group">
                        <label>×“×œ×§</label>
                        <input type="number" class="exp" disabled data-cat="×“×œ×§" placeholder="0" step="0.01" oninput="calculate()">
                    </div>
                    <div class="input-group">
                        <label>××•×¡×š</label>
                        <input type="number" class="exp" disabled data-cat="××•×¡×š" placeholder="0" step="0.01" oninput="calculate()">
                    </div>
                    <div class="input-group">
                        <label>×›×‘×™×© 6</label>
                        <input type="number" class="exp" disabled data-cat="×›×‘×™×© 6" placeholder="0" step="0.01" oninput="calculate()">
                    </div>
                    <div class="input-group">
                        <label>××™×ª×•×¨×Ÿ</label>
                        <input type="number" class="exp" disabled data-cat="××™×ª×•×¨×Ÿ" placeholder="0" step="0.01" oninput="calculate()">
                    </div>
                    <div class="input-group">
                        <label>×‘×™×˜×•×— ×¨×›×‘ (×œ×œ× ××¢"×)</label>
                        <input type="number" class="exp" disabled data-cat="×‘×™×˜×•×— ×¨×›×‘" data-novat="true" placeholder="0" step="0.01" oninput="calculate()">
                    </div>
                    <div class="input-group">
                        <label>×¨×©×™×•×Ÿ ×¨×›×‘ (×œ×œ× ××¢"×)</label>
                        <input type="number" class="exp" disabled data-cat="×¨×©×™×•×Ÿ ×¨×›×‘" data-novat="true" placeholder="0" step="0.01" oninput="calculate()">
                    </div>
                    <div class="input-group">
                        <label>××—×¨</label>
                        <input type="number" class="exp" disabled data-cat="×¨×›×‘ - ××—×¨" placeholder="0" step="0.01" oninput="calculate()">
                    </div>
                    <div class="category-total">
                        <span class="category-total-label">ğŸš™ ×¡×”"×› ×¨×›×‘</span>
                        <div class="category-total-col">
                            <div class="category-total-col-label">×¡×”"×›</div>
                            <div class="category-total-col-value" id="total-vehicle">â‚ª0</div>
                        </div>
                        <div class="category-total-col">
                            <div class="category-total-col-label">×œ×œ× ××¢"×</div>
                            <div class="category-total-col-value" id="total-vehicle-net">â‚ª0</div>
                        </div>
                        <div class="category-total-col">
                            <div class="category-total-col-label">××¢"×</div>
                            <div class="category-total-col-value" id="total-vehicle-vat">â‚ª0</div>
                        </div>
                    </div>
                </div>

                <div class="collapse-header" onclick="toggle('training')">ğŸ“š ×”×“×¨×›×”</div>
                <div class="collapse-content" id="training">
                    <div class="input-group">
                        <label>×§×•×¨×¡×™×</label>
                        <input type="number" class="exp" disabled data-cat="×§×•×¨×¡×™×" placeholder="0" step="0.01" oninput="calculate()">
                    </div>
                    <div class="input-group">
                        <label>×›× ×¡×™×</label>
                        <input type="number" class="exp" disabled data-cat="×›× ×¡×™×" placeholder="0" step="0.01" oninput="calculate()">
                    </div>
                    <div class="input-group">
                        <label>×§×œ×™× ×™×§×”</label>
                        <input type="number" class="exp" disabled data-cat="×§×œ×™× ×™×§×”" placeholder="0" step="0.01" oninput="calculate()">
                    </div>
                    <div class="input-group">
                        <label>×”×“×¨×›×” ××§×¦×•×¢×™×ª</label>
                        <input type="number" class="exp" disabled data-cat="×”×“×¨×›×” ××§×¦×•×¢×™×ª" placeholder="0" step="0.01" oninput="calculate()">
                    </div>
                    <div class="category-total">
                        <span class="category-total-label">ğŸ“š ×¡×”"×› ×”×“×¨×›×”</span>
                        <div class="category-total-col">
                            <div class="category-total-col-label">×¡×”"×›</div>
                            <div class="category-total-col-value" id="total-training">â‚ª0</div>
                        </div>
                        <div class="category-total-col">
                            <div class="category-total-col-label">×œ×œ× ××¢"×</div>
                            <div class="category-total-col-value" id="total-training-net">â‚ª0</div>
                        </div>
                        <div class="category-total-col">
                            <div class="category-total-col-label">××¢"×</div>
                            <div class="category-total-col-value" id="total-training-vat">â‚ª0</div>
                        </div>
                    </div>
                </div>

                <div class="collapse-header" onclick="toggle('home')">ğŸ  ×“×™×¨×”</div>
                <div class="collapse-content" id="home">
                    <div class="input-group">
                        <label>×—×©××œ</label>
                        <input type="number" id="electric" disabled placeholder="0" step="0.01" oninput="calculate()">
                    </div>
                    <div class="input-group">
                        <label>××™×</label>
                        <input type="number" id="water" disabled placeholder="0" step="0.01" oninput="calculate()">
                    </div>
                    <div class="input-group">
                        <label>××¨× ×•× ×” (×œ×œ× ××¢"×)</label>
                        <input type="number" id="arnona" disabled data-novat="true" placeholder="0" step="0.01" oninput="calculate()">
                    </div>
                    <div class="input-group">
                        <label>×‘×™×˜×•×— (×œ×œ× ××¢"×)</label>
                        <input type="number" id="homeInsurance" disabled data-novat="true" placeholder="0" step="0.01" oninput="calculate()">
                    </div>
                    <div class="input-group">
                        <label>××—×¨</label>
                        <input type="number" id="homeOther" disabled placeholder="0" step="0.01" oninput="calculate()">
                    </div>
                    <div class="category-total">
                        <span class="category-total-label" id="home-total-label">ğŸ  ×¡×”"×› ×“×™×¨×” (20%)</span>
                        <div class="category-total-col">
                            <div class="category-total-col-label">×¡×”"×›</div>
                            <div class="category-total-col-value" id="total-home">â‚ª0</div>
                        </div>
                        <div class="category-total-col">
                            <div class="category-total-col-label">×œ×œ× ××¢"×</div>
                            <div class="category-total-col-value" id="total-home-net">â‚ª0</div>
                        </div>
                        <div class="category-total-col">
                            <div class="category-total-col-label">××¢"×</div>
                            <div class="category-total-col-value" id="total-home-vat">â‚ª0</div>
                        </div>
                    </div>
                </div>

                <button class="btn-calculate" onclick="calculate()" disabled id="calculateBtn">×—×©×‘ ğŸ§®</button>
                <button class="btn-freeze" onclick="freezePeriod()" disabled id="freezeBtn">ğŸ”’ × ×¢×œ ×•×©××•×¨</button>
            </div>
        </div>

        <!-- Tabs -->
        <div class="card">
            <div class="tabs-header">
                <button class="tab-button active" onclick="switchTab('current')">×ª×§×•×¤×” × ×•×›×—×™×ª</button>
                <button class="tab-button" onclick="switchTab('annual')">×¡×™×›×•× ×©× ×ª×™</button>
            </div>

            <div class="tab-content active" id="current">
                <div class="summary-grid">
                    <div class="summary-box">
                        <div class="summary-box-label">×”×›× ×¡×•×ª</div>
                        <div class="summary-box-value" id="curInc">â‚ª0</div>
                    </div>
                    <div class="summary-box">
                        <div class="summary-box-label">×”×•×¦××•×ª</div>
                        <div class="summary-box-value" id="curExp">â‚ª0</div>
                    </div>
                    <div class="summary-box success">
                        <div class="summary-box-label">×¨×•×•×—</div>
                        <div class="summary-box-value" id="curProf">â‚ª0</div>
                    </div>
                    <div class="summary-box warning">
                        <div class="summary-box-label">××¢"× ×œ×ª×©×œ×•×</div>
                        <div class="summary-box-value" id="curVAT">â‚ª0</div>
                    </div>
                    <div class="summary-box" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
                        <div class="summary-box-label" style="color: white; opacity: 0.9;">××§×“××•×ª ××¡ ×”×›× ×¡×”</div>
                        <div class="summary-box-value" style="color: white;" id="curAdvTax">â‚ª0</div>
                    </div>
                </div>

                <!-- Detailed expense VAT breakdown -->
                <div style="margin-top: 1.5rem; background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 12px; padding: 1.25rem;">
                    <h3 style="font-size: 1rem; font-weight: 700; color: #1a365d; margin-bottom: 1rem; border-bottom: 2px solid #e2e8f0; padding-bottom: 0.5rem;">ğŸ“Š ×¤×™×¨×•×˜ ××¢"× ×”×•×¦××•×ª ×œ×“×™×•×•×—</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                        <div style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 0.75rem;">
                            <div style="font-size: 0.75rem; color: #64748b; margin-bottom: 0.25rem;">×”×•×¦××•×ª ×œ×œ× ××¢"× (×œ×œ× ×¦×™×•×“)</div>
                            <div style="font-size: 1.1rem; font-weight: 700; color: #1a365d;" id="expNetNoEquip">â‚ª0</div>
                        </div>
                        <div style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 0.75rem;">
                            <div style="font-size: 0.75rem; color: #64748b; margin-bottom: 0.25rem;">××¢"× ×”×•×¦××•×ª (×œ×œ× ×¦×™×•×“, ×¨×›×‘ Ã—0.667)</div>
                            <div style="font-size: 1.1rem; font-weight: 700; color: #f59e0b;" id="expVATAdjusted">â‚ª0</div>
                        </div>
                        <div style="background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 0.75rem;">
                            <div style="font-size: 0.75rem; color: #64748b; margin-bottom: 0.25rem;">××¢"× ×¢×œ ×¦×™×•×“ ××©×¨×“×™</div>
                            <div style="font-size: 1.1rem; font-weight: 700; color: #8b5cf6;" id="equipVATDisplay">â‚ª0</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #1a365d, #2d4a7c); border-radius: 8px; padding: 0.75rem;">
                            <div style="font-size: 0.75rem; color: rgba(255,255,255,0.8); margin-bottom: 0.25rem;">××¢"× ×œ×ª×©×œ×•× (××ª×•××)</div>
                            <div style="font-size: 1.1rem; font-weight: 700; color: white;" id="vatAdjustedPayable">â‚ª0</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-content" id="annual">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;">
                    <h3 style="margin:0;font-size:1.2rem;color:#1a365d;">×¡×™×›×•× ×©× ×ª×™</h3>
                    <button onclick="exportToExcel()" style="padding:0.6rem 1.5rem;background:linear-gradient(135deg,#10b981,#059669);color:white;border:none;border-radius:8px;font-weight:700;cursor:pointer;box-shadow:0 2px 8px rgba(16,185,129,0.3);">
                        ğŸ“¥ ×™×™×¦× ×œ××§×¡×œ
                    </button>
                </div>
                <div class="summary-grid">
                    <div class="summary-box">
                        <div class="summary-box-label">×”×›× ×¡×•×ª ×©× ×ª×™×•×ª</div>
                        <div class="summary-box-value" id="annInc">â‚ª0</div>
                    </div>
                    <div class="summary-box">
                        <div class="summary-box-label">×”×•×¦××•×ª ×©× ×ª×™×•×ª</div>
                        <div class="summary-box-value" id="annExp">â‚ª0</div>
                    </div>
                    <div class="summary-box success">
                        <div class="summary-box-label">×¨×•×•×—×™×•×ª</div>
                        <div class="summary-box-value" id="annProf">â‚ª0</div>
                    </div>
                    <div class="summary-box warning">
                        <div class="summary-box-label">××¢"× ×©× ×ª×™</div>
                        <div class="summary-box-value" id="annVAT">â‚ª0</div>
                    </div>
                    <div class="summary-box" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
                        <div class="summary-box-label" style="color: white; opacity: 0.9;">××§×“××•×ª ××¡ ×©× ×ª×™×•×ª</div>
                        <div class="summary-box-value" style="color: white;" id="annAdvTax">â‚ª0</div>
                    </div>
                </div>

                <h3 style="margin-top: 2rem; margin-bottom: 1rem; font-size: 1.2rem;">×¤×™×¨×•×˜ ×œ×¤×™ ×§×˜×’×•×¨×™×•×ª</h3>
                <table id="categoryTable">
                    <thead>
                        <tr>
                            <th>×§×˜×’×•×¨×™×”</th>
                            <th>×™× ×•-×¤×‘×¨</th>
                            <th>××¨×¥-××¤×¨</th>
                            <th>×××™-×™×•× ×™</th>
                            <th>×™×•×œ-××•×’</th>
                            <th>×¡×¤×˜-××•×§</th>
                            <th>× ×•×‘-×“×¦×</th>
                            <th>×¡×”"×›</th>
                        </tr>
                    </thead>
                    <tbody id="catBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Saved Periods -->
        <div class="card">
            <h2 class="card-title">ğŸ’¾ ×ª×§×•×¤×•×ª ×©××•×¨×•×ª</h2>
            <div id="savedContainer"></div>
        </div>
    </div>

    <script>
        let VAT = 0.18, advanceTaxPercent = 0.06;
        let currentPeriod = null, saved = [], INCOME_TAX_RATE = 0.31;

        let _prevVAT = 18, _prevAdv = 6, _prevHome = 20; // Store previous values for cancel

        function startEditSettings() {
            _prevVAT = parseFloat(document.getElementById('vatRate').value);
            _prevAdv = parseFloat(document.getElementById('advanceTaxPercent').value);
            _prevHome = parseFloat(document.getElementById('homeOfficePercent').value);

            ['vatRate', 'advanceTaxPercent', 'homeOfficePercent'].forEach(id => {
                const el = document.getElementById(id);
                el.removeAttribute('readonly');
                el.style.background = '';
                el.style.cursor = '';
            });

            document.getElementById('editSettingsBtn').style.display = 'none';
            document.getElementById('saveSettingsBtn').style.display = 'inline-block';
            document.getElementById('cancelSettingsBtn').style.display = 'inline-block';

            document.getElementById('vatRate').focus();
        }

        function saveSettings() {
            const vatInput = parseFloat(document.getElementById('vatRate').value);
            const advInput = parseFloat(document.getElementById('advanceTaxPercent').value);
            const homeInput = parseFloat(document.getElementById('homeOfficePercent').value);

            if (!isNaN(vatInput) && vatInput > 0) VAT = vatInput / 100;
            if (!isNaN(advInput) && advInput >= 0) advanceTaxPercent = advInput / 100;

            localStorage.setItem('vatRate', VAT);
            localStorage.setItem('advanceTaxPercent', advanceTaxPercent);
            localStorage.setItem('homeOfficePercent', isNaN(homeInput) ? 20 : homeInput);

            lockSettings();
            calculate();
            calcAnnual();
        }

        function cancelSettings() {
            document.getElementById('vatRate').value = _prevVAT;
            document.getElementById('advanceTaxPercent').value = _prevAdv;
            document.getElementById('homeOfficePercent').value = _prevHome;
            lockSettings();
        }

        function lockSettings() {
            ['vatRate', 'advanceTaxPercent', 'homeOfficePercent'].forEach(id => {
                const el = document.getElementById(id);
                el.setAttribute('readonly', true);
                el.style.background = '#f1f5f9';
                el.style.cursor = 'not-allowed';
            });

            document.getElementById('editSettingsBtn').style.display = 'inline-block';
            document.getElementById('saveSettingsBtn').style.display = 'none';
            document.getElementById('cancelSettingsBtn').style.display = 'none';
        }

        function updateSettings() {
            const vatInput = parseFloat(document.getElementById('vatRate').value);
            const advInput = parseFloat(document.getElementById('advanceTaxPercent').value);
            if (!isNaN(vatInput) && vatInput > 0) VAT = vatInput / 100;
            if (!isNaN(advInput) && advInput >= 0) advanceTaxPercent = advInput / 100;
            localStorage.setItem('vatRate', VAT);
            localStorage.setItem('advanceTaxPercent', advanceTaxPercent);
            calculate();
            calcAnnual();
        }


        function selectPeriod(num, name) {
            currentPeriod = {num, name};
            document.querySelectorAll(".period-btn").forEach((b, i) => b.classList.toggle("active", i === num - 1));
            
            // Enable all inputs
            enableInputs();
            
            const p = saved.find(s => s.period.num === num);
            if (p) { 
                if (confirm(`×˜×¢×Ÿ ${name}?`)) {
                    loadPeriod(p);
                } else {
                    clearInputs();
                }
            } else {
                clearInputs();
            }
        }

        function enableInputs() {
            // Enable all number inputs except settings
            document.querySelectorAll("input[type=number]").forEach(i => {
                if (i.id !== "vatRate" && i.id !== "advanceTaxPercent" && i.id !== "homeOfficePercent") {
                    i.disabled = false;
                }
            });
            
            // Enable buttons
            const calcBtn = document.getElementById("calculateBtn");
            const freezeBtn = document.getElementById("freezeBtn");
            if (calcBtn) calcBtn.disabled = false;
            if (freezeBtn) freezeBtn.disabled = false;
            
            // Hide warning
            const warning = document.getElementById("noPeriodWarning");
            if (warning) warning.style.display = "none";
            
            // Show selected period indicator
            const indicator = document.getElementById("selectedPeriodIndicator");
            const periodName = document.getElementById("selectedPeriodName");
            if (indicator && periodName && currentPeriod) {
                periodName.textContent = currentPeriod.name;
                indicator.style.display = "block";
            }
        }

        function disableInputs() {
            // Disable all number inputs except settings
            document.querySelectorAll("input[type=number]").forEach(i => {
                if (i.id !== "vatRate" && i.id !== "advanceTaxPercent" && i.id !== "homeOfficePercent") {
                    i.disabled = true;
                }
            });
            
            // Disable buttons
            const calcBtn = document.getElementById("calculateBtn");
            const freezeBtn = document.getElementById("freezeBtn");
            if (calcBtn) calcBtn.disabled = true;
            if (freezeBtn) freezeBtn.disabled = true;
            
            // Show warning
            const warning = document.getElementById("noPeriodWarning");
            if (warning) warning.style.display = "block";
        }

        function clearInputs() {
            document.querySelectorAll("input[type=number]").forEach(i => {
                if (i.id !== "vatRate" && i.id !== "advanceTaxPercent" && i.id !== "homeOfficePercent") i.value = "";
            });
            calculate();
        }

        function toggle(id) {
            const el = document.getElementById(id);
            el.classList.toggle('active');
        }

        function fmt(n) { return 'â‚ª' + Math.round(n).toLocaleString('he-IL'); }
        function sepVAT(t) { const n = t / (1 + VAT); return {n, v: t - n}; }

        function calculate() {
            const inc = parseFloat(document.getElementById('totalIncome').value) || 0;
            const {n: incN, v: incV} = sepVAT(inc);
            
            let expT = 0, expN = 0, vatP = 0;
            const cats = {};
            let totTransport = 0, totTransportNet = 0, totTransportVAT = 0;
            let totOffice = 0, totOfficeNet = 0, totOfficeVAT = 0;
            let totEquipment = 0, totEquipmentNet = 0, totEquipmentVAT = 0;
            let totVehicle = 0, totVehicleNet = 0, totVehicleVAT = 0;
            let totTraining = 0, totTrainingNet = 0, totTrainingVAT = 0;
            
            document.querySelectorAll('.exp').forEach(i => {
                const val = parseFloat(i.value) || 0;
                const cat = i.dataset.cat;
                const novat = i.dataset.novat;
                let netVal = val, vatVal = 0;
                
                if (novat) {
                    expT += val; expN += val;
                    netVal = val; vatVal = 0;
                } else {
                    const {n, v} = sepVAT(val);
                    expT += val; expN += n; vatP += v;
                    netVal = n; vatVal = v;
                }
                
                if (cat && val > 0) cats[cat] = (cats[cat] || 0) + val;
                
                // Accumulate section totals with net and VAT
                const section = i.closest('.collapse-content');
                if (section) {
                    if (section.id === 'transport') { totTransport += val; totTransportNet += netVal; totTransportVAT += vatVal; }
                    else if (section.id === 'office') { totOffice += val; totOfficeNet += netVal; totOfficeVAT += vatVal; }
                    else if (section.id === 'equipment') { totEquipment += val; totEquipmentNet += netVal; totEquipmentVAT += vatVal; }
                    else if (section.id === 'vehicle') { totVehicle += val; totVehicleNet += netVal; totVehicleVAT += vatVal; }
                    else if (section.id === 'training') { totTraining += val; totTrainingNet += netVal; totTrainingVAT += vatVal; }
                }
            });

            // Home office 1/7
            const e = parseFloat(document.getElementById('electric').value) || 0;
            const w = parseFloat(document.getElementById('water').value) || 0;
            const a = parseFloat(document.getElementById('arnona').value) || 0;
            const homeIns = parseFloat(document.getElementById('homeInsurance').value) || 0;
            const homeOth = parseFloat(document.getElementById('homeOther').value) || 0;
            const homeRatio = (parseFloat(document.getElementById('homeOfficePercent').value) || 20) / 100;
            const eS = sepVAT(e), wS = sepVAT(w), homeOthS = sepVAT(homeOth);
            const homeN = (eS.n + wS.n + a + homeIns + homeOthS.n) * homeRatio;
            const homeV = (eS.v + wS.v + homeOthS.v) * homeRatio;
            const homeT = (e + w + a + homeIns + homeOth) * homeRatio;
            expT += homeT; expN += homeN; vatP += homeV;

            // Update home section label dynamically
            const homePct = Math.round(homeRatio * 100);
            const homeLabelEl = document.getElementById('home-total-label');
            if (homeLabelEl) homeLabelEl.textContent = `ğŸ  ×¡×”"×› ×“×™×¨×” (${homePct}%)`;

            const vat = incV - vatP;
            const prof = incN - expN;
            const advTax = incN * advanceTaxPercent; // ××§×“××•×ª = ×”×›× ×¡×” ×œ×œ× ××¢"× Ã— ××—×•×–

            // Update category totals (gross, net, VAT)
            document.getElementById('total-transport').textContent = fmt(totTransport);
            document.getElementById('total-transport-net').textContent = fmt(totTransportNet);
            document.getElementById('total-transport-vat').textContent = fmt(totTransportVAT);

            document.getElementById('total-office').textContent = fmt(totOffice);
            document.getElementById('total-office-net').textContent = fmt(totOfficeNet);
            document.getElementById('total-office-vat').textContent = fmt(totOfficeVAT);

            document.getElementById('total-equipment').textContent = fmt(totEquipment);
            document.getElementById('total-equipment-net').textContent = fmt(totEquipmentNet);
            document.getElementById('total-equipment-vat').textContent = fmt(totEquipmentVAT);

            document.getElementById('total-vehicle').textContent = fmt(totVehicle);
            document.getElementById('total-vehicle-net').textContent = fmt(totVehicleNet);
            document.getElementById('total-vehicle-vat').textContent = fmt(totVehicleVAT);

            document.getElementById('total-training').textContent = fmt(totTraining);
            document.getElementById('total-training-net').textContent = fmt(totTrainingNet);
            document.getElementById('total-training-vat').textContent = fmt(totTrainingVAT);

            document.getElementById('total-home').textContent = fmt(homeT);
            document.getElementById('total-home-net').textContent = fmt(homeN);
            document.getElementById('total-home-vat').textContent = fmt(homeV);

            document.getElementById('curInc').textContent = fmt(inc);
            document.getElementById('curExp').textContent = fmt(expT);
            document.getElementById('curProf').textContent = fmt(prof);
            document.getElementById('curVAT').textContent = fmt(vat);
            document.getElementById('curAdvTax').textContent = fmt(advTax);

            // Income summary breakdown
            document.getElementById('inc-total').textContent = fmt(inc);
            document.getElementById('inc-net').textContent = fmt(incN);
            document.getElementById('inc-vat').textContent = fmt(incV);

            // Detailed expense VAT breakdown:
            // - Exclude equipment (×¦×™×•×“ ××©×¨×“×™) from net expenses and VAT
            // - Vehicle VAT Ã— 0.667 only
            const expNetNoEquip = expN - totEquipmentNet;
            const vatVehicleAdjusted = totVehicleVAT * 0.667;
            const vatOther = totTransportVAT + totOfficeVAT + totTrainingVAT + homeV;
            const expVATAdjusted = vatOther + vatVehicleAdjusted;
            const vatAdjustedPayable = incV - expVATAdjusted - totEquipmentVAT;

            document.getElementById('expNetNoEquip').textContent = fmt(expNetNoEquip);
            document.getElementById('expVATAdjusted').textContent = fmt(expVATAdjusted);
            document.getElementById('equipVATDisplay').textContent = fmt(totEquipmentVAT);
            document.getElementById('vatAdjustedPayable').textContent = fmt(vatAdjustedPayable);

            return {inc, expT, incN, expN, vat, prof, cats, advTax};
        }

        function freezePeriod() {
            if (!currentPeriod) return alert('×‘×—×¨ ×ª×§×•×¤×”');
            const inc = parseFloat(document.getElementById('totalIncome').value) || 0;
            if (inc === 0) return alert('×”×–×Ÿ ×”×›× ×¡×”');
            if (!confirm(`× ×¢×œ ${currentPeriod.name}?`)) return;

            const data = calculate();
            const inputs = {};
            document.querySelectorAll('input[type="number"]').forEach(i => {
                if (i.id !== 'vatRate' && i.id !== 'advanceTaxPercent' && i.id !== 'homeOfficePercent') inputs[i.id || i.dataset.cat] = i.value;
            });

            saved = saved.filter(s => s.period.num !== currentPeriod.num);
            saved.push({period: currentPeriod, data, inputs});
            localStorage.setItem('saved', JSON.stringify(saved));
            
            renderSaved();
            alert(`${currentPeriod.name} × ×©××¨! âœ…`);
        }

        function renderSaved() {
            if (saved.length === 0) {
                document.getElementById('savedContainer').innerHTML = '<p style="text-align:center;color:#64748b;padding:2rem;">××™×Ÿ ×ª×§×•×¤×•×ª</p>';
                return;
            }
            
            document.getElementById('savedContainer').innerHTML = saved.sort((a,b) => a.period.num - b.period.num).map(s => `
                <div style="background:#f8fafc;border:2px solid #e2e8f0;border-radius:8px;padding:1rem;margin-bottom:0.5rem;">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <strong style="color:var(--primary);">${s.period.name}</strong>
                        <div>
                            <button onclick="delPeriod(${s.period.num})" style="padding:0.5rem 1rem;background:#dc2626;color:white;border:none;border-radius:6px;margin-left:0.5rem;cursor:pointer;">××—×§</button>
                            <button onclick="loadSaved(${s.period.num})" style="padding:0.5rem 1rem;background:var(--primary);color:white;border:none;border-radius:6px;cursor:pointer;">×˜×¢×Ÿ</button>
                        </div>
                    </div>
                    <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:0.5rem;margin-top:0.5rem;font-size:0.85rem;">
                        <div>×”×›× ×¡×•×ª: ${fmt(s.data.inc)}</div>
                        <div>×”×•×¦××•×ª: ${fmt(s.data.expT)}</div>
                        <div style="color:var(--success);">×¨×•×•×—: ${fmt(s.data.prof)}</div>
                        <div>××¢"×: ${fmt(s.data.vat)}</div>
                        <div style="color:#8b5cf6;">××§×“××•×ª: ${fmt(s.data.advTax || 0)}</div>
                    </div>
                </div>
            `).join('');
        }

        function loadSaved(num) {
            const s = saved.find(p => p.period.num === num);
            if (!s) return;
            selectPeriod(s.period.num, s.period.name);
            loadPeriod(s);
        }

        function loadPeriod(s) {
            Object.keys(s.inputs).forEach(k => {
                const el = document.getElementById(k) || document.querySelector(`[data-cat="${k}"]`);
                if (el) el.value = s.inputs[k];
            });
            calculate();
        }

        function delPeriod(num) {
            if (!confirm('××—×§?')) return;
            saved = saved.filter(s => s.period.num !== num);
            localStorage.setItem('saved', JSON.stringify(saved));
            renderSaved();
            calcAnnual();
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(tab).classList.add('active');
            if (tab === 'annual') calcAnnual();
        }

        function calcAnnual() {
            if (saved.length === 0) {
                document.getElementById('catBody').innerHTML = '<tr><td colspan="8" style="text-align:center;padding:2rem;color:#64748b;">××™×Ÿ ×ª×§×•×¤×•×ª</td></tr>';
                return;
            }

            let totInc = 0, totExp = 0, totProf = 0, totVAT = 0, totIncN = 0, totAdvTax = 0;
            const allCats = {};

            saved.forEach(s => {
                totInc += s.data.inc;
                totExp += s.data.expT;
                totProf += s.data.prof;
                totVAT += s.data.vat;
                totIncN += s.data.incN;
                totAdvTax += (s.data.advTax || 0);
                
                Object.keys(s.data.cats || {}).forEach(cat => {
                    if (!allCats[cat]) allCats[cat] = Array(6).fill(0);
                    allCats[cat][s.period.num - 1] = s.data.cats[cat];
                });
            });

            document.getElementById('annInc').textContent = fmt(totInc);
            document.getElementById('annExp').textContent = fmt(totExp);
            document.getElementById('annProf').textContent = fmt(totProf);
            document.getElementById('annVAT').textContent = fmt(totVAT);
            document.getElementById('annAdvTax').textContent = fmt(totAdvTax);

            let html = '';
            Object.keys(allCats).sort().forEach(cat => {
                const row = allCats[cat];
                const tot = row.reduce((a, b) => a + b, 0);
                html += `<tr>
                    <td style="font-weight:600;">${cat}</td>
                    ${row.map(v => `<td>${v > 0 ? fmt(v) : '-'}</td>`).join('')}
                    <td style="font-weight:700;">${fmt(tot)}</td>
                </tr>`;
            });
            
            html += `<tr class="total-row">
                <td>×¡×”"×› ×”×›× ×¡×•×ª</td>
                ${Array(6).fill(0).map((_, i) => {
                    const s = saved.find(p => p.period.num === i + 1);
                    return `<td>${s ? fmt(s.data.inc) : '-'}</td>`;
                }).join('')}
                <td>${fmt(totInc)}</td>
            </tr>`;

            document.getElementById('catBody').innerHTML = html;

            // Tax calculations using fixed 31% income tax rate
            const incTax = totProf * INCOME_TAX_RATE;
            const natIns = totProf * 0.12;
            const healthIns = totProf * 0.05;
            const totTax = incTax + natIns + healthIns;
            
            // Calculate advance tax payments as percentage of annual income (without VAT)
            const advanceTaxPaid = totIncN * advanceTaxPercent;
            const taxBalance = totTax - advanceTaxPaid;
            const netProf = totProf - totTax;

            document.getElementById('taxProf').textContent = fmt(totProf);
            document.getElementById('incTax').textContent = fmt(incTax);
            document.getElementById('natIns').textContent = fmt(natIns);
            document.getElementById('healthIns').textContent = fmt(healthIns);
            document.getElementById('totTax').textContent = fmt(totTax);
            document.getElementById('advPaid').textContent = fmt(advanceTaxPaid);
            document.getElementById('taxBalance').textContent = fmt(taxBalance);
            document.getElementById('netProf').textContent = fmt(netProf);
        }

        window.onload = () => {
            const s = localStorage.getItem('saved');
            if (s) { saved = JSON.parse(s); renderSaved(); }
            toggle('transport');
        };
    </script>

        function selectPeriod(num, name) {
            currentPeriod = {num, name};
            document.querySelectorAll('.period-btn').forEach((b, i) => b.classList.toggle('active', i === num - 1));
            const p = saved.find(s => s.period.num === num);
            if (p) { if (confirm(`×˜×¢×Ÿ ${name}?`)) loadPeriod(p); else clearInputs(); }
            else clearInputs();
        }

        function clearInputs() {
            document.querySelectorAll('input[type="number"]').forEach(i => {
                if (i.id !== 'vatRate' && i.id !== 'advanceTaxPercent' && i.id !== 'homeOfficePercent') i.value = '';
            });
            calculate();
        }

        function toggle(id) {
            const el = document.getElementById(id);
            el.classList.toggle('active');
        }

        function fmt(n) { return 'â‚ª' + Math.round(n).toLocaleString('he-IL'); }
        function sepVAT(t) { const n = t / (1 + VAT); return {n, v: t - n}; }

        function calculate() {
            const inc = parseFloat(document.getElementById('totalIncome').value) || 0;
            const {n: incN, v: incV} = sepVAT(inc);
            
            let expT = 0, expN = 0, vatP = 0;
            const cats = {};
            
            document.querySelectorAll('.exp').forEach(i => {
                const val = parseFloat(i.value) || 0;
                const cat = i.dataset.cat;
                const novat = i.dataset.novat;
                
                if (novat) {
                    expT += val; expN += val;
                } else {
                    const {n, v} = sepVAT(val);
                    expT += val; expN += n; vatP += v;
                }
                
                if (cat && val > 0) cats[cat] = (cats[cat] || 0) + val;
            });

            // Home office 1/7
            const e = parseFloat(document.getElementById('"electric"').value) || 0;            const w = parseFloat(document.getElementById('"water"').value) || 0;            const a = parseFloat(document.getElementById('"arnona"').value) || 0;            const homeIns = parseFloat(document.getElementById('"homeInsurance"').value) || 0;            const homeOth = parseFloat(document.getElementById('"homeOther"').value) || 0;            const eS = sepVAT(e), wS = sepVAT(w), homeOthS = sepVAT(homeOth);            const homeN = (eS.n + wS.n + a + homeIns + homeOthS.n) / 7;            const homeV = (eS.v + wS.v + homeOthS.v) / 7;            const homeT = (e + w + a + homeIns + homeOth) / 7;
            expT += homeT; expN += homeN; vatP += homeV;

            const vat = incV - vatP;
            const prof = incN - expN;

            document.getElementById('curInc').textContent = fmt(inc);
            document.getElementById('curExp').textContent = fmt(expT);
            document.getElementById('curProf').textContent = fmt(prof);
            document.getElementById('curVAT').textContent = fmt(vat);

            return {inc, expT, incN, expN, vat, prof, cats};
        }

        function freezePeriod() {
            if (!currentPeriod) return alert('×‘×—×¨ ×ª×§×•×¤×”');
            const inc = parseFloat(document.getElementById('totalIncome').value) || 0;
            if (inc === 0) return alert('×”×–×Ÿ ×”×›× ×¡×”');
            if (!confirm(`× ×¢×œ ${currentPeriod.name}?`)) return;

            const data = calculate();
            const inputs = {};
            document.querySelectorAll('input[type="number"]').forEach(i => {
                if (i.id !== 'vatRate' && i.id !== 'advanceTax') inputs[i.id || i.dataset.cat] = i.value;
            });

            saved = saved.filter(s => s.period.num !== currentPeriod.num);
            saved.push({period: currentPeriod, data, inputs});
            localStorage.setItem('saved', JSON.stringify(saved));
            
            renderSaved();
            alert(`${currentPeriod.name} × ×©××¨! âœ…`);
        }

        function renderSaved() {
            if (saved.length === 0) {
                document.getElementById('savedContainer').innerHTML = '<p style="text-align:center;color:#64748b;padding:2rem;">××™×Ÿ ×ª×§×•×¤×•×ª</p>';
                return;
            }
            
            document.getElementById('savedContainer').innerHTML = saved.sort((a,b) => a.period.num - b.period.num).map(s => `
                <div style="background:#f8fafc;border:2px solid #e2e8f0;border-radius:8px;padding:1rem;margin-bottom:0.5rem;">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <strong style="color:var(--primary);">${s.period.name}</strong>
                        <div>
                            <button onclick="delPeriod(${s.period.num})" style="padding:0.5rem 1rem;background:#dc2626;color:white;border:none;border-radius:6px;margin-left:0.5rem;cursor:pointer;">××—×§</button>
                            <button onclick="loadSaved(${s.period.num})" style="padding:0.5rem 1rem;background:var(--primary);color:white;border:none;border-radius:6px;cursor:pointer;">×˜×¢×Ÿ</button>
                        </div>
                    </div>
                    <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:0.5rem;margin-top:0.5rem;font-size:0.85rem;">
                        <div>×”×›× ×¡×•×ª: ${fmt(s.data.inc)}</div>
                        <div>×”×•×¦××•×ª: ${fmt(s.data.expT)}</div>
                        <div style="color:var(--success);">×¨×•×•×—: ${fmt(s.data.prof)}</div>
                        <div>××¢"×: ${fmt(s.data.vat)}</div>
                        <div style="color:#8b5cf6;">××§×“××•×ª: ${fmt(s.data.advTax || 0)}</div>
                    </div>
                </div>
            `).join('');
        }

        function loadSaved(num) {
            const s = saved.find(p => p.period.num === num);
            if (!s) return;
            selectPeriod(s.period.num, s.period.name);
            loadPeriod(s);
        }

        function loadPeriod(s) {
            Object.keys(s.inputs).forEach(k => {
                const el = document.getElementById(k) || document.querySelector(`[data-cat="${k}"]`);
                if (el) el.value = s.inputs[k];
            });
            calculate();
        }

        function delPeriod(num) {
            if (!confirm('××—×§?')) return;
            saved = saved.filter(s => s.period.num !== num);
            localStorage.setItem('saved', JSON.stringify(saved));
            renderSaved();
            calcAnnual();
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(tab).classList.add('active');
            if (tab === 'annual') calcAnnual();
        }

        function calcAnnual() {
            if (saved.length === 0) {
                document.getElementById('catBody').innerHTML = '<tr><td colspan="8" style="text-align:center;padding:2rem;color:#64748b;">××™×Ÿ ×ª×§×•×¤×•×ª</td></tr>';
                return;
            }

            let totInc = 0, totExp = 0, totProf = 0, totVAT = 0;
            const allCats = {};

            saved.forEach(s => {
                totInc += s.data.inc;
                totExp += s.data.expT;
                totProf += s.data.prof;
                totVAT += s.data.vat;
                
                Object.keys(s.data.cats || {}).forEach(cat => {
                    if (!allCats[cat]) allCats[cat] = Array(6).fill(0);
                    allCats[cat][s.period.num - 1] = s.data.cats[cat];
                });
            });

            document.getElementById('annInc').textContent = fmt(totInc);
            document.getElementById('annExp').textContent = fmt(totExp);
            document.getElementById('annProf').textContent = fmt(totProf);
            document.getElementById('annVAT').textContent = fmt(totVAT);

            let html = '';
            Object.keys(allCats).sort().forEach(cat => {
                const row = allCats[cat];
                const tot = row.reduce((a, b) => a + b, 0);
                html += `<tr>
                    <td style="font-weight:600;">${cat}</td>
                    ${row.map(v => `<td>${v > 0 ? fmt(v) : '-'}</td>`).join('')}
                    <td style="font-weight:700;">${fmt(tot)}</td>
                </tr>`;
            });
            
            html += `<tr class="total-row">
                <td>×¡×”"×› ×”×›× ×¡×•×ª</td>
                ${Array(6).fill(0).map((_, i) => {
                    const s = saved.find(p => p.period.num === i + 1);
                    return `<td>${s ? fmt(s.data.inc) : '-'}</td>`;
                }).join('')}
                <td>${fmt(totInc)}</td>
            </tr>`;

            document.getElementById('catBody').innerHTML = html;

            // Tax calculations using fixed 31% income tax rate
            const incTax = totProf * INCOME_TAX_RATE;
            const natIns = totProf * 0.12;
            const healthIns = totProf * 0.05;
            const totTax = incTax + natIns + healthIns;
            const advanceTaxPaid = totProf * advanceTaxPercent;
            const taxBalance = totTax - advanceTaxPaid;
            const netProf = totProf - totTax;

            document.getElementById('taxProf').textContent = fmt(totProf);
            document.getElementById('incTax').textContent = fmt(incTax);
            document.getElementById('natIns').textContent = fmt(natIns);
            document.getElementById('healthIns').textContent = fmt(healthIns);
            document.getElementById('totTax').textContent = fmt(totTax);
            document.getElementById('advPaid').textContent = fmt(advanceTaxPaid);
            document.getElementById('taxBalance').textContent = fmt(taxBalance);
            document.getElementById('netProf').textContent = fmt(netProf);
        }

        window.onload = () => {
            const s = localStorage.getItem('saved');
            if (s) { saved = JSON.parse(s); renderSaved(); }
            toggle('transport');
        };
    </script>

        function selectPeriod(num, name) {
            currentPeriod = {num, name};
            document.querySelectorAll('.period-btn').forEach((b, i) => b.classList.toggle('active', i === num - 1));
            const p = saved.find(s => s.period.num === num);
            if (p) { if (confirm(`×˜×¢×Ÿ ${name}?`)) loadPeriod(p); else clearInputs(); }
            else clearInputs();
        }

        function clearInputs() {
            document.querySelectorAll('input[type="number"]').forEach(i => {
                if (!i.id.includes('tax') && i.id !== 'vatRate') i.value = '';
            });
            calculate();
        }

        function toggle(id) {
            const el = document.getElementById(id);
            el.classList.toggle('active');
        }

        function fmt(n) { return 'â‚ª' + Math.round(n).toLocaleString('he-IL'); }
        function sepVAT(t) { const n = t / (1 + VAT); return {n, v: t - n}; }

        function calculate() {
            const inc = parseFloat(document.getElementById('totalIncome').value) || 0;
            const {n: incN, v: incV} = sepVAT(inc);
            
            let expT = 0, expN = 0, vatP = 0;
            const cats = {};
            
            document.querySelectorAll('.exp').forEach(i => {
                const val = parseFloat(i.value) || 0;
                const cat = i.dataset.cat;
                const novat = i.dataset.novat;
                
                if (novat) {
                    expT += val; expN += val;
                } else {
                    const {n, v} = sepVAT(val);
                    expT += val; expN += n; vatP += v;
                }
                
                if (cat && val > 0) cats[cat] = (cats[cat] || 0) + val;
            });

            // Home office 1/7
            const e = parseFloat(document.getElementById('"electric"').value) || 0;            const w = parseFloat(document.getElementById('"water"').value) || 0;            const a = parseFloat(document.getElementById('"arnona"').value) || 0;            const homeIns = parseFloat(document.getElementById('"homeInsurance"').value) || 0;            const homeOth = parseFloat(document.getElementById('"homeOther"').value) || 0;            const eS = sepVAT(e), wS = sepVAT(w), homeOthS = sepVAT(homeOth);            const homeN = (eS.n + wS.n + a + homeIns + homeOthS.n) / 7;            const homeV = (eS.v + wS.v + homeOthS.v) / 7;            const homeT = (e + w + a + homeIns + homeOth) / 7;
            expT += homeT; expN += homeN; vatP += homeV;

            const vat = incV - vatP;
            const prof = incN - expN;
            const advTax = incN * advanceTaxPercent; // Advance tax based on income without VAT

            document.getElementById('curInc').textContent = fmt(inc);
            document.getElementById('curExp').textContent = fmt(expT);
            document.getElementById('curProf').textContent = fmt(prof);
            document.getElementById('curVAT').textContent = fmt(vat);
            document.getElementById('curAdvTax').textContent = fmt(advTax);

            return {inc, expT, incN, expN, vat, prof, cats, advTax};
        }

        function calcIncomeTax(amt) {
            let tax = 0, rem = amt, prev = 0;
            for (let i = 0; i < BRACKETS.length; i++) {
                if (rem <= 0) break;
                const bracket = Math.min(rem, BRACKETS[i] - prev);
                tax += bracket * TAX[i];
                rem -= bracket;
                prev = BRACKETS[i];
            }
            return tax;
        }

        function freezePeriod() {
            if (!currentPeriod) return alert('×‘×—×¨ ×ª×§×•×¤×”');
            const inc = parseFloat(document.getElementById('totalIncome').value) || 0;
            if (inc === 0) return alert('×”×–×Ÿ ×”×›× ×¡×”');
            if (!confirm(`× ×¢×œ ${currentPeriod.name}?`)) return;

            const data = calculate();
            const inputs = {};
            document.querySelectorAll('input[type="number"]').forEach(i => {
                if (!i.id.includes('tax') && i.id !== 'vatRate') inputs[i.id || i.dataset.cat] = i.value;
            });

            saved = saved.filter(s => s.period.num !== currentPeriod.num);
            saved.push({period: currentPeriod, data, inputs});
            localStorage.setItem('saved', JSON.stringify(saved));
            
            renderSaved();
            alert(`${currentPeriod.name} × ×©××¨! âœ…`);
        }

        function renderSaved() {
            if (saved.length === 0) {
                document.getElementById('savedContainer').innerHTML = '<p style="text-align:center;color:#64748b;padding:2rem;">××™×Ÿ ×ª×§×•×¤×•×ª</p>';
                return;
            }
            
            document.getElementById('savedContainer').innerHTML = saved.sort((a,b) => a.period.num - b.period.num).map(s => `
                <div style="background:#f8fafc;border:2px solid #e2e8f0;border-radius:8px;padding:1rem;margin-bottom:0.5rem;">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <strong style="color:var(--primary);">${s.period.name}</strong>
                        <div>
                            <button onclick="delPeriod(${s.period.num})" style="padding:0.5rem 1rem;background:#dc2626;color:white;border:none;border-radius:6px;margin-left:0.5rem;cursor:pointer;">××—×§</button>
                            <button onclick="loadSaved(${s.period.num})" style="padding:0.5rem 1rem;background:var(--primary);color:white;border:none;border-radius:6px;cursor:pointer;">×˜×¢×Ÿ</button>
                        </div>
                    </div>
                    <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:0.5rem;margin-top:0.5rem;font-size:0.85rem;">
                        <div>×”×›× ×¡×•×ª: ${fmt(s.data.inc)}</div>
                        <div>×”×•×¦××•×ª: ${fmt(s.data.expT)}</div>
                        <div style="color:var(--success);">×¨×•×•×—: ${fmt(s.data.prof)}</div>
                        <div>××¢"×: ${fmt(s.data.vat)}</div>
                        <div style="color:#8b5cf6;">××§×“××•×ª: ${fmt(s.data.advTax || 0)}</div>
                    </div>
                </div>
            `).join('');
        }

        function loadSaved(num) {
            const s = saved.find(p => p.period.num === num);
            if (!s) return;
            selectPeriod(s.period.num, s.period.name);
            loadPeriod(s);
        }

        function loadPeriod(s) {
            Object.keys(s.inputs).forEach(k => {
                const el = document.getElementById(k) || document.querySelector(`[data-cat="${k}"]`);
                if (el) el.value = s.inputs[k];
            });
            calculate();
        }

        function delPeriod(num) {
            if (!confirm('××—×§?')) return;
            saved = saved.filter(s => s.period.num !== num);
            localStorage.setItem('saved', JSON.stringify(saved));
            renderSaved();
            calcAnnual();
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(tab).classList.add('active');
            if (tab === 'annual') calcAnnual();
        }

        function calcAnnual() {
            if (saved.length === 0) {
                document.getElementById('catBody').innerHTML = '<tr><td colspan="8" style="text-align:center;padding:2rem;color:#64748b;">××™×Ÿ ×ª×§×•×¤×•×ª</td></tr>';
                return;
            }

            let totInc = 0, totExp = 0, totProf = 0, totVAT = 0;
            const allCats = {};

            saved.forEach(s => {
                totInc += s.data.inc;
                totExp += s.data.expT;
                totProf += s.data.prof;
                totVAT += s.data.vat;
                
                Object.keys(s.data.cats || {}).forEach(cat => {
                    if (!allCats[cat]) allCats[cat] = Array(6).fill(0);
                    allCats[cat][s.period.num - 1] = s.data.cats[cat];
                });
            });

            document.getElementById('annInc').textContent = fmt(totInc);
            document.getElementById('annExp').textContent = fmt(totExp);
            document.getElementById('annProf').textContent = fmt(totProf);
            document.getElementById('annVAT').textContent = fmt(totVAT);

            let html = '';
            Object.keys(allCats).sort().forEach(cat => {
                const row = allCats[cat];
                const tot = row.reduce((a, b) => a + b, 0);
                html += `<tr>
                    <td style="font-weight:600;">${cat}</td>
                    ${row.map(v => `<td>${v > 0 ? fmt(v) : '-'}</td>`).join('')}
                    <td style="font-weight:700;">${fmt(tot)}</td>
                </tr>`;
            });
            
            html += `<tr class="total-row">
                <td>×¡×”"×› ×”×›× ×¡×•×ª</td>
                ${Array(6).fill(0).map((_, i) => {
                    const s = saved.find(p => p.period.num === i + 1);
                    return `<td>${s ? fmt(s.data.inc) : '-'}</td>`;
                }).join('')}
                <td>${fmt(totInc)}</td>
            </tr>`;

            document.getElementById('catBody').innerHTML = html;

            const incTax = totProf * INCOME_TAX_RATE;
            const natIns = totProf * 0.12;
            const healthIns = totProf * 0.05;
            const totTax = incTax + natIns + healthIns;
            const advanceTaxPaid = totIncN * advanceTaxPercent; // ××§×“××•×ª = ×”×›× ×¡×” ×œ×œ× ××¢"× Ã— ××—×•×–
            const taxBalance = totTax - advanceTaxPaid;
            const netProf = totProf - totTax;

            document.getElementById('taxProf').textContent = fmt(totProf);
            document.getElementById('incTax').textContent = fmt(incTax);
            document.getElementById('natIns').textContent = fmt(natIns);
            document.getElementById('healthIns').textContent = fmt(healthIns);
            document.getElementById('totTax').textContent = fmt(totTax);
            document.getElementById('advPaid').textContent = fmt(advanceTaxPaid);
            document.getElementById('taxBalance').textContent = fmt(taxBalance);
            document.getElementById('netProf').textContent = fmt(netProf);
        }

        window.onload = () => {
            // Load saved periods
            const s = localStorage.getItem('saved');
            if (s) { saved = JSON.parse(s); renderSaved(); }
            
            // Load saved settings
            const savedVAT = localStorage.getItem('vatRate');
            const savedAdvTax = localStorage.getItem('advanceTaxPercent');
            const savedHomePct = localStorage.getItem('homeOfficePercent');
            
            if (savedVAT) {
                VAT = parseFloat(savedVAT);
                document.getElementById('vatRate').value = (VAT * 100).toFixed(1);
            }
            if (savedAdvTax) {
                advanceTaxPercent = parseFloat(savedAdvTax);
                document.getElementById('advanceTaxPercent').value = (advanceTaxPercent * 100).toFixed(1);
            }
            if (savedHomePct) {
                document.getElementById('homeOfficePercent').value = parseFloat(savedHomePct);
            }
            
            toggle('transport');
        };
    </script>
</body>
</html>
<script>
// â”€â”€â”€ Invoice Upload & AI Processing â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let uploadedFiles = [];
let classifiedResults = {};
let detectedPeriod = null;

const PERIOD_NAMES = {
    '×™× ×•××¨-×¤×‘×¨×•××¨': 1, '×™× ×•-×¤×‘×¨': 1, 'january-february': 1, 'jan-feb': 1,
    '××¨×¥-××¤×¨×™×œ': 2, '××¨×¥-××¤×¨': 2, 'march-april': 2, 'mar-apr': 2,
    '×××™-×™×•× ×™': 3, 'may-june': 3, 'may-jun': 3,
    '×™×•×œ×™-××•×’×•×¡×˜': 4, '×™×•×œ-××•×’': 4, 'july-august': 4, 'jul-aug': 4,
    '×¡×¤×˜××‘×¨-××•×§×˜×•×‘×¨': 5, '×¡×¤×˜-××•×§': 5, 'september-october': 5, 'sep-oct': 5,
    '× ×•×‘××‘×¨-×“×¦××‘×¨': 6, '× ×•×‘-×“×¦×': 6, 'november-december': 6, 'nov-dec': 6
};

const CATEGORY_MAP = {
    '××•× ×™×•×ª': { field: null, cat: '××•× ×™×•×ª' },
    'taxi': { field: null, cat: '××•× ×™×•×ª' },
    '×—× ×™×”': { field: null, cat: '×—× ×™×”' },
    'parking': { field: null, cat: '×—× ×™×”' },
    '×—× ×™×” ××¢"× ××¤×¡': { field: null, cat: '×—× ×™×” ××¢×´× ××¤×¡' },
    'parking_zero_vat': { field: null, cat: '×—× ×™×” ××¢×´× ××¤×¡' },
    '×”×•×¦××•×ª ××©×¨×“': { field: null, cat: '××©×¨×“×™' },
    'office': { field: null, cat: '××©×¨×“×™' },
    '× ×™×”×•×œ ×™×•××Ÿ ×¤×¡×™×›×•×œ×•×’': { field: null, cat: '× ×™×”×•×œ ×™×•××Ÿ ×¤×¡×™×›×•×œ×•×’' },
    'diary_management': { field: null, cat: '× ×™×”×•×œ ×™×•××Ÿ ×¤×¡×™×›×•×œ×•×’' },
    '×¦×™×•×“ ××©×¨×“×™': { field: null, cat: '×¦×™×•×“ ××©×¨×“×™' },
    'equipment': { field: null, cat: '×¦×™×•×“ ××©×¨×“×™' },
    '×“×œ×§': { field: null, cat: '×“×œ×§' },
    'fuel': { field: null, cat: '×“×œ×§' },
    '××•×¡×š': { field: null, cat: '××•×¡×š' },
    'garage': { field: null, cat: '××•×¡×š' },
    '×›×‘×™×© 6': { field: null, cat: '×›×‘×™×© 6' },
    'highway': { field: null, cat: '×›×‘×™×© 6' },
    '××™×ª×•×¨×Ÿ': { field: null, cat: '××™×ª×•×¨×Ÿ' },
    'itoran': { field: null, cat: '××™×ª×•×¨×Ÿ' },
    '×‘×™×˜×•×— ×¨×›×‘': { field: null, cat: '×‘×™×˜×•×— ×¨×›×‘' },
    'car_insurance': { field: null, cat: '×‘×™×˜×•×— ×¨×›×‘' },
    '×¨×©×™×•×Ÿ ×¨×›×‘': { field: null, cat: '×¨×©×™×•×Ÿ ×¨×›×‘' },
    'car_license': { field: null, cat: '×¨×©×™×•×Ÿ ×¨×›×‘' },
    '×¨×›×‘ ××—×¨': { field: null, cat: '×¨×›×‘ - ××—×¨' },
    'vehicle_other': { field: null, cat: '×¨×›×‘ - ××—×¨' },
    '×§×•×¨×¡×™×': { field: null, cat: '×§×•×¨×¡×™×' },
    'courses': { field: null, cat: '×§×•×¨×¡×™×' },
    '×›× ×¡×™×': { field: null, cat: '×›× ×¡×™×' },
    'conferences': { field: null, cat: '×›× ×¡×™×' },
    '×§×œ×™× ×™×§×”': { field: null, cat: '×§×œ×™× ×™×§×”' },
    'clinic': { field: null, cat: '×§×œ×™× ×™×§×”' },
    '×”×“×¨×›×” ××§×¦×•×¢×™×ª': { field: null, cat: '×”×“×¨×›×” ××§×¦×•×¢×™×ª' },
    'training': { field: null, cat: '×”×“×¨×›×” ××§×¦×•×¢×™×ª' },
    '×—×©××œ': { field: 'electric', cat: null },
    'electricity': { field: 'electric', cat: null },
    '××™×': { field: 'water', cat: null },
    'water': { field: 'water', cat: null },
    '××¨× ×•× ×”': { field: 'arnona', cat: null },
    'arnona': { field: 'arnona', cat: null },
    '×‘×™×˜×•×— ×“×™×¨×”': { field: 'homeInsurance', cat: null },
    'home_insurance': { field: 'homeInsurance', cat: null },
    '×”×›× ×¡×•×ª': { field: 'totalIncome', cat: null },
    'income': { field: 'totalIncome', cat: null }
};

function openUploadModal() {
    document.getElementById('uploadModal').style.display = 'block';
}

function closeUploadModal() {
    document.getElementById('uploadModal').style.display = 'none';
    uploadedFiles = [];
    classifiedResults = {};
    detectedPeriod = null;
    document.getElementById('fileItems').innerHTML = '';
    document.getElementById('fileList').style.display = 'none';
    document.getElementById('resultsArea').style.display = 'none';
    document.getElementById('processBtn').disabled = true;
    document.getElementById('processBtn').style.opacity = '0.4';
    document.getElementById('processBtn').textContent = 'ğŸ¤– ×¢×‘×“ ×—×©×‘×•× ×™×•×ª ×¢× AI';
    document.getElementById('uploadPeriodSelect').value = '';
}

function handleFolderDrop(event) {
    event.preventDefault();
    document.getElementById('dropZone').style.borderColor = '#cbd5e1';
    document.getElementById('dropZone').style.background = '';
    
    const items = event.dataTransfer.items;
    const promises = [];
    
    for (let i = 0; i < items.length; i++) {
        const item = items[i].webkitGetAsEntry();
        if (item) {
            promises.push(traverseFileTreeAsync(item, ''));
        }
    }
    
    Promise.all(promises).then(results => {
        const allFiles = results.flat();
        handleFolderSelect(allFiles);
    });
}

async function traverseFileTreeAsync(item, path) {
    return new Promise((resolve) => {
        if (item.isFile) {
            item.file(file => {
                file.fullPath = path + file.name;
                resolve([file]);
            });
        } else if (item.isDirectory) {
            const dirReader = item.createReader();
            dirReader.readEntries(async (entries) => {
                const promises = entries.map(entry => 
                    traverseFileTreeAsync(entry, path + item.name + '/')
                );
                const results = await Promise.all(promises);
                resolve(results.flat());
            });
        } else {
            resolve([]);
        }
    });
}

function handleFolderSelect(files) {
    uploadedFiles = [];
    classifiedResults = {};
    detectedPeriod = null;
    
    const filesArray = Array.isArray(files) ? files : Array.from(files);
    
    filesArray.forEach(file => {
        const path = file.webkitRelativePath || file.fullPath || file.name;
        const parts = path.split('/').filter(p => p);
        
        if (parts.length >= 2) {
            // Can be: [period]/[category]/[file] OR [category]/[file]
            let periodFolder = null;
            let categoryFolder = null;
            let fileName = parts[parts.length - 1];
            
            if (parts.length >= 3) {
                // Full structure: period/category/file
                periodFolder = parts[0].toLowerCase().trim();
                categoryFolder = parts[1].toLowerCase().trim();
            } else if (parts.length === 2) {
                // Simplified: category/file (no period folder)
                categoryFolder = parts[0].toLowerCase().trim();
            }
            
            // Detect period from folder name
            if (periodFolder && !detectedPeriod) {
                for (const [key, val] of Object.entries(PERIOD_NAMES)) {
                    if (periodFolder.includes(key.toLowerCase())) {
                        detectedPeriod = val;
                        document.getElementById('uploadPeriodSelect').value = val;
                        break;
                    }
                }
            }
            
            // Map category
            const mapping = CATEGORY_MAP[categoryFolder];
            const categoryName = mapping ? (mapping.cat || categoryFolder) : categoryFolder;
            
            uploadedFiles.push({ file, category: categoryName, path });
        }
    });
    
    renderFileList();
}

function renderFileList() {
    const container = document.getElementById('fileItems');
    
    if (uploadedFiles.length === 0) {
        container.innerHTML = '<div style="padding:1rem;text-align:center;color:#94a3b8;">×œ× × ××¦××• ×§×‘×¦×™× ×‘××‘× ×” ×”× ×›×•×Ÿ</div>';
        document.getElementById('fileList').style.display = 'block';
        document.getElementById('processBtn').disabled = true;
        document.getElementById('processBtn').style.opacity = '0.4';
        return;
    }
    
    // Group by category
    const grouped = {};
    uploadedFiles.forEach((item, idx) => {
        if (!grouped[item.category]) grouped[item.category] = [];
        grouped[item.category].push({ ...item, idx });
    });
    
    container.innerHTML = Object.entries(grouped).map(([cat, items]) => `
        <div style="margin-bottom:1rem;">
            <div style="font-weight:700;color:#1a365d;font-size:0.9rem;margin-bottom:0.5rem;padding:0.5rem;background:#f1f5f9;border-radius:6px;">
                ğŸ“‚ ${cat} (${items.length} ×§×‘×¦×™×)
            </div>
            ${items.map(item => `
                <div style="display:flex;align-items:center;gap:0.5rem;padding:0.4rem 0.5rem;border-bottom:1px solid #f8fafc;">
                    <span style="font-size:1rem;">${item.file.name.toLowerCase().endsWith('.pdf') ? 'ğŸ“„' : 'ğŸ–¼ï¸'}</span>
                    <span style="flex:1;font-size:0.8rem;color:#64748b;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${item.file.name}</span>
                    <span style="font-size:0.7rem;color:#cbd5e1;">${(item.file.size/1024).toFixed(0)}KB</span>
                </div>
            `).join('')}
        </div>
    `).join('');
    
    document.getElementById('fileList').style.display = 'block';
    const btn = document.getElementById('processBtn');
    btn.disabled = false;
    btn.style.opacity = '1';
}

function removeFile(i) { uploadedFiles.splice(i, 1); renderFileList(); }

async function fileToBase64(file) {
    return new Promise((res, rej) => {
        const r = new FileReader();
        r.onload = () => res(r.result.split(',')[1]);
        r.onerror = rej;
        r.readAsDataURL(file);
    });
}

async function processInvoices() {
    const periodVal = document.getElementById('uploadPeriodSelect').value;
    if (!periodVal) { alert('× × ×œ×‘×—×•×¨ ×ª×§×•×¤×” ×œ×¤× ×™ ×”×¢×™×‘×•×“'); return; }

    const btn = document.getElementById('processBtn');
    btn.textContent = 'â³ ××¢×‘×“...';
    btn.disabled = true;

    classifiedResults = {};
    const unreadable = [];
    const resultsContent = document.getElementById('resultsContent');
    resultsContent.innerHTML = '<div style="color:#64748b;font-size:0.9rem;">××¢×‘×“ ×§×‘×¦×™×...</div>';
    document.getElementById('resultsArea').style.display = 'block';
    document.getElementById('manualArea').style.display = 'none';

    for (const item of uploadedFiles) {
        try {
            const b64 = await fileToBase64(item.file);
            const mediaType = item.file.type || (item.file.name.toLowerCase().endsWith('.pdf') ? 'application/pdf' : 'image/jpeg');

            const prompt = `Extract the TOTAL AMOUNT from this invoice. Return ONLY a JSON object:
{"readable": true, "amount": <number>}
OR if you cannot read the amount clearly: {"readable": false}

The amount should be the final total on the invoice (including VAT if present).`;

            const msgContent = mediaType === 'application/pdf'
                ? [{ type: 'document', source: { type: 'base64', media_type: 'application/pdf', data: b64 } }, { type: 'text', text: prompt }]
                : [{ type: 'image', source: { type: 'base64', media_type: mediaType, data: b64 } }, { type: 'text', text: prompt }];

            const resp = await fetch('https://api.anthropic.com/v1/messages', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ model: 'claude-sonnet-4-5-20250929', max_tokens: 500, messages: [{ role: 'user', content: msgContent }] })
            });

            const data = await resp.json();
            const rawText = data.content?.map(c => c.text || '').join('').replace(/```json|```/g, '').trim();
            const parsed = JSON.parse(rawText);

            if (!parsed.readable || !parsed.amount) {
                unreadable.push({ name: item.file.name, category: item.category });
                resultsContent.innerHTML += `<div style="background:#fef3c7;border:1px solid #f59e0b;border-radius:8px;padding:0.6rem;margin-bottom:0.5rem;font-size:0.85rem;">âš ï¸ <strong>${item.file.name}</strong> (${item.category}) â€” ×œ× × ×™×ª×Ÿ ×œ×§×¨×™××”</div>`;
            } else {
                if (!classifiedResults[item.category]) classifiedResults[item.category] = 0;
                classifiedResults[item.category] += parsed.amount;
                
                resultsContent.innerHTML += `
                    <div style="background:#f0fdf4;border:1px solid #86efac;border-radius:8px;padding:0.75rem;margin-bottom:0.5rem;">
                        <div style="font-weight:700;color:#166534;font-size:0.85rem;">âœ… ${item.file.name}</div>
                        <div style="font-size:0.8rem;color:#374151;margin-top:0.2rem;">â†’ ${item.category}: â‚ª${Math.round(parsed.amount).toLocaleString('he-IL')}</div>
                    </div>`;
            }
        } catch (e) {
            unreadable.push({ name: item.file.name, category: item.category });
            resultsContent.innerHTML += `<div style="background:#fee2e2;border:1px solid #fca5a5;border-radius:8px;padding:0.6rem;margin-bottom:0.5rem;font-size:0.85rem;">âŒ <strong>${item.file.name}</strong> â€” ×©×’×™××” ×‘×¢×™×‘×•×“</div>`;
        }
    }

    // Manual entry for unreadable files
    if (unreadable.length > 0) {
        document.getElementById('manualArea').style.display = 'block';
        document.getElementById('manualItems').innerHTML = unreadable.map(item => {
            const key = item.name.replace(/[^a-zA-Z0-9]/g, '_');
            return `<div style="margin-bottom:0.75rem;padding:0.75rem;background:white;border-radius:6px;">
                <div style="font-size:0.85rem;font-weight:600;color:#92400e;margin-bottom:0.4rem;">ğŸ“„ ${item.name}</div>
                <div style="font-size:0.75rem;color:#78350f;margin-bottom:0.3rem;">×§×˜×’×•×¨×™×”: ${item.category}</div>
                <input type="number" id="manAmt_${key}" data-category="${item.category}" placeholder="×¡×›×•× ×›×•×œ×œ ××¢×´×" style="width:100%;padding:0.5rem;border:1px solid #fbbf24;border-radius:6px;font-size:0.9rem;">
            </div>`;
        }).join('');
    }

    btn.textContent = 'ğŸ¤– ×¢×‘×“ ×—×©×‘×•× ×™×•×ª ×¢× AI';
    btn.disabled = false;
    btn.style.opacity = '1';
}

function applyResults() {
    const periodVal = document.getElementById('uploadPeriodSelect').value;
    if (!periodVal) { alert('× × ×œ×‘×—×•×¨ ×ª×§×•×¤×”'); return; }

    // Collect manual entries
    document.querySelectorAll('[id^="manAmt_"]').forEach(input => {
        const cat = input.getAttribute('data-category');
        const amt = parseFloat(input.value) || 0;
        if (cat && amt > 0) {
            classifiedResults[cat] = (classifiedResults[cat] || 0) + amt;
        }
    });

    // Select the period
    const periodNames = ['','×™× ×•××¨-×¤×‘×¨×•××¨','××¨×¥-××¤×¨×™×œ','×××™-×™×•× ×™','×™×•×œ×™-××•×’×•×¡×˜','×¡×¤×˜××‘×¨-××•×§×˜×•×‘×¨','× ×•×‘××‘×¨-×“×¦××‘×¨'];
    selectPeriod(parseInt(periodVal), periodNames[parseInt(periodVal)]);

    // Apply each classified amount to the correct field
    let appliedCount = 0;
    Object.entries(classifiedResults).forEach(([cat, total]) => {
        const mapping = CATEGORY_MAP[cat.toLowerCase()];
        
        if (!mapping) {
            // Try direct match without mapping
            const el = document.querySelector(`input[data-cat="${cat}"]`);
            if (el) {
                el.value = Math.round((parseFloat(el.value) || 0) + total);
                appliedCount++;
            }
            return;
        }
        
        if (mapping.field) {
            const el = document.getElementById(mapping.field);
            if (el) {
                el.value = Math.round((parseFloat(el.value) || 0) + total);
                appliedCount++;
            }
        } else if (mapping.cat) {
            const el = document.querySelector(`input[data-cat="${mapping.cat}"]`);
            if (el) {
                el.value = Math.round((parseFloat(el.value) || 0) + total);
                appliedCount++;
            }
        }
    });

    calculate();
    closeUploadModal();
    alert(`âœ… ${appliedCount} ×§×˜×’×•×¨×™×•×ª ×”×•×¢×‘×¨×• ×‘×”×¦×œ×—×”!`);
}

// â”€â”€â”€ Export to Excel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function exportToExcel() {
    const periodNames = ['×™× ×•××¨-×¤×‘×¨×•××¨', '××¨×¥-××¤×¨×™×œ', '×××™-×™×•× ×™', '×™×•×œ×™-××•×’×•×¡×˜', '×¡×¤×˜××‘×¨-××•×§×˜×•×‘×¨', '× ×•×‘××‘×¨-×“×¦××‘×¨'];
    
    // Build CSV content
    let csv = '\uFEFF'; // UTF-8 BOM for Hebrew support
    
    // Header
    csv += '×¡×¢×™×£,' + periodNames.join(',') + ',×¡×”"×› ×©× ×ª×™\n';
    
    // Helper function to add row
    const addRow = (name, values, total) => {
        csv += name + ',';
        csv += values.map(v => Math.round(v)).join(',');
        csv += ',' + Math.round(total) + '\n';
    };
    
    // Get data from saved periods
    const data = {};
    const initKey = (key) => { if (!data[key]) data[key] = [0,0,0,0,0,0]; };
    
    // Initialize all keys
    ['income', '××•× ×™×•×ª', '×—× ×™×”', '×—× ×™×” ××¢×´× ××¤×¡', '××©×¨×“×™', '× ×™×”×•×œ ×™×•××Ÿ ×¤×¡×™×›×•×œ×•×’', '×¦×™×•×“ ××©×¨×“×™',
     '×“×œ×§', '××•×¡×š', '×›×‘×™×© 6', '××™×ª×•×¨×Ÿ', '×‘×™×˜×•×— ×¨×›×‘', '×¨×©×™×•×Ÿ ×¨×›×‘', '×¨×›×‘ - ××—×¨',
     '×§×•×¨×¡×™×', '×›× ×¡×™×', '×§×œ×™× ×™×§×”', '×”×“×¨×›×” ××§×¦×•×¢×™×ª',
     'electric', 'water', 'arnona', 'homeInsurance', 'homeOther',
     'expenses', 'profit', 'vat', 'advTax'].forEach(initKey);
    
    // Fill from saved periods
    saved.forEach((period, idx) => {
        if (idx >= 6) return;
        const periodData = period.data || {};
        const inputs = period.inputs || {};
        
        data.income[idx] = periodData.inc || 0;
        data.expenses[idx] = periodData.expT || 0;
        data.profit[idx] = periodData.prof || 0;
        data.vat[idx] = periodData.vat || 0;
        data.advTax[idx] = periodData.advTax || 0;
        
        // Map inputs
        Object.keys(inputs).forEach(key => {
            const val = parseFloat(inputs[key]) || 0;
            if (data[key] !== undefined) data[key][idx] = val;
        });
    });
    
    // Calculate totals
    const sum = (arr) => arr.reduce((a,b) => a+b, 0);
    
    // Build rows
    addRow('×”×›× ×¡×•×ª', data.income, sum(data.income));
    csv += '\n';
    
    // Transport
    csv += '×ª×—×‘×•×¨×”\n';
    addRow('  ××•× ×™×•×ª', data['××•× ×™×•×ª'], sum(data['××•× ×™×•×ª']));
    addRow('  ×—× ×™×”', data['×—× ×™×”'], sum(data['×—× ×™×”']));
    addRow('  ×—× ×™×” ××¢"× ××¤×¡', data['×—× ×™×” ××¢×´× ××¤×¡'], sum(data['×—× ×™×” ××¢×´× ××¤×¡']));
    const transportTotals = [0,1,2,3,4,5].map(i => (data['××•× ×™×•×ª'][i] || 0) + (data['×—× ×™×”'][i] || 0) + (data['×—× ×™×” ××¢×´× ××¤×¡'][i] || 0));
    addRow('×¡×”"×› ×ª×—×‘×•×¨×”', transportTotals, sum(transportTotals));
    csv += '\n';
    
    // Office
    csv += '××©×¨×“\n';
    addRow('  ×”×•×¦××•×ª ××©×¨×“', data['××©×¨×“×™'], sum(data['××©×¨×“×™']));
    addRow('  × ×™×”×•×œ ×™×•××Ÿ ×¤×¡×™×›×•×œ×•×’', data['× ×™×”×•×œ ×™×•××Ÿ ×¤×¡×™×›×•×œ×•×’'], sum(data['× ×™×”×•×œ ×™×•××Ÿ ×¤×¡×™×›×•×œ×•×’']));
    const officeTotals = [0,1,2,3,4,5].map(i => (data['××©×¨×“×™'][i] || 0) + (data['× ×™×”×•×œ ×™×•××Ÿ ×¤×¡×™×›×•×œ×•×’'][i] || 0));
    addRow('×¡×”"×› ××©×¨×“', officeTotals, sum(officeTotals));
    csv += '\n';
    
    // Equipment
    csv += '×¦×™×•×“ ××©×¨×“×™\n';
    addRow('  ×¦×™×•×“ ××©×¨×“×™', data['×¦×™×•×“ ××©×¨×“×™'], sum(data['×¦×™×•×“ ××©×¨×“×™']));
    addRow('×¡×”"×› ×¦×™×•×“ ××©×¨×“×™', data['×¦×™×•×“ ××©×¨×“×™'], sum(data['×¦×™×•×“ ××©×¨×“×™']));
    csv += '\n';
    
    // Vehicle
    csv += '×¨×›×‘\n';
    addRow('  ×“×œ×§', data['×“×œ×§'], sum(data['×“×œ×§']));
    addRow('  ××•×¡×š', data['××•×¡×š'], sum(data['××•×¡×š']));
    addRow('  ×›×‘×™×© 6', data['×›×‘×™×© 6'], sum(data['×›×‘×™×© 6']));
    addRow('  ××™×ª×•×¨×Ÿ', data['××™×ª×•×¨×Ÿ'], sum(data['××™×ª×•×¨×Ÿ']));
    addRow('  ×‘×™×˜×•×— ×¨×›×‘', data['×‘×™×˜×•×— ×¨×›×‘'], sum(data['×‘×™×˜×•×— ×¨×›×‘']));
    addRow('  ×¨×©×™×•×Ÿ ×¨×›×‘', data['×¨×©×™×•×Ÿ ×¨×›×‘'], sum(data['×¨×©×™×•×Ÿ ×¨×›×‘']));
    addRow('  ×¨×›×‘ - ××—×¨', data['×¨×›×‘ - ××—×¨'], sum(data['×¨×›×‘ - ××—×¨']));
    const vehicleTotals = [0,1,2,3,4,5].map(i => 
        (data['×“×œ×§'][i] || 0) + (data['××•×¡×š'][i] || 0) + (data['×›×‘×™×© 6'][i] || 0) + 
        (data['××™×ª×•×¨×Ÿ'][i] || 0) + (data['×‘×™×˜×•×— ×¨×›×‘'][i] || 0) + (data['×¨×©×™×•×Ÿ ×¨×›×‘'][i] || 0) + 
        (data['×¨×›×‘ - ××—×¨'][i] || 0)
    );
    addRow('×¡×”"×› ×¨×›×‘', vehicleTotals, sum(vehicleTotals));
    csv += '\n';
    
    // Training
    csv += '×”×“×¨×›×”\n';
    addRow('  ×§×•×¨×¡×™×', data['×§×•×¨×¡×™×'], sum(data['×§×•×¨×¡×™×']));
    addRow('  ×›× ×¡×™×', data['×›× ×¡×™×'], sum(data['×›× ×¡×™×']));
    addRow('  ×§×œ×™× ×™×§×”', data['×§×œ×™× ×™×§×”'], sum(data['×§×œ×™× ×™×§×”']));
    addRow('  ×”×“×¨×›×” ××§×¦×•×¢×™×ª', data['×”×“×¨×›×” ××§×¦×•×¢×™×ª'], sum(data['×”×“×¨×›×” ××§×¦×•×¢×™×ª']));
    const trainingTotals = [0,1,2,3,4,5].map(i => 
        (data['×§×•×¨×¡×™×'][i] || 0) + (data['×›× ×¡×™×'][i] || 0) + (data['×§×œ×™× ×™×§×”'][i] || 0) + (data['×”×“×¨×›×” ××§×¦×•×¢×™×ª'][i] || 0)
    );
    addRow('×¡×”"×› ×”×“×¨×›×”', trainingTotals, sum(trainingTotals));
    csv += '\n';
    
    // Home
    csv += '×“×™×¨×”\n';
    addRow('  ×—×©××œ', data.electric, sum(data.electric));
    addRow('  ××™×', data.water, sum(data.water));
    addRow('  ××¨× ×•× ×”', data.arnona, sum(data.arnona));
    addRow('  ×‘×™×˜×•×— ×“×™×¨×”', data.homeInsurance, sum(data.homeInsurance));
    addRow('  ××—×¨', data.homeOther, sum(data.homeOther));
    const homeTotals = [0,1,2,3,4,5].map(i => 
        (data.electric[i] || 0) + (data.water[i] || 0) + (data.arnona[i] || 0) + 
        (data.homeInsurance[i] || 0) + (data.homeOther[i] || 0)
    );
    addRow('×¡×”"×› ×“×™×¨×”', homeTotals, sum(homeTotals));
    csv += '\n';
    
    // Totals
    addRow('×¡×”"×› ×”×•×¦××•×ª', data.expenses, sum(data.expenses));
    addRow('×¨×•×•×—', data.profit, sum(data.profit));
    csv += '\n';
    addRow('××¢"× ×œ×ª×©×œ×•×', data.vat, sum(data.vat));
    addRow('××§×“××•×ª ××¡', data.advTax, sum(data.advTax));
    
    // Add notes
    csv += '\n\n×”×¢×¨×•×ª:\n';
    csv += '×©×™×¢×•×¨ ××¢"×: ' + (VAT*100).toFixed(1) + '%\n';
    csv += '××—×•×– ××§×“××•×ª ××¡: ' + (advanceTaxPercent*100).toFixed(1) + '%\n';
    csv += '××—×•×– ×©×™××•×© ×¢×¡×§×™ ×‘×“×™×¨×”: ' + document.getElementById('homeOfficePercent').value + '%\n';
    csv += '×ª××¨×™×š ×”×¤×§×”: ' + new Date().toLocaleDateString('he-IL') + '\n';
    
    // Download
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', '×“×•×—_×©× ×ª×™_' + new Date().toISOString().split('T')[0] + '.csv');
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    alert('âœ… ×”×§×•×‘×¥ ×”×•×¨×“ ×‘×”×¦×œ×—×”!\n\n×¤×ª×— ××•×ª×• ×‘××§×¡×œ ×œ×¦×¤×™×™×”.');
}

function executePrint() {
    // Deprecated - kept for compatibility
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
</script>

<!-- PWA Service Worker Registration -->
<script>
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js')
            .then(registration => console.log('âœ… PWA: Service Worker registered'))
            .catch(err => console.log('âŒ PWA: Service Worker registration failed:', err));
    });
}

// PWA Install prompt
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    
    // Show install button in header
    const installBtn = document.createElement('button');
    installBtn.textContent = 'ğŸ“¥ ×”×ª×§×Ÿ ××¤×œ×™×§×¦×™×”';
    installBtn.style.cssText = 'margin-top:1rem;padding:0.75rem 2rem;background:linear-gradient(135deg,#8b5cf6,#7c3aed);color:white;border:none;border-radius:10px;font-size:1.1rem;font-weight:700;cursor:pointer;box-shadow:0 4px 15px rgba(139,92,246,0.4);';
    installBtn.onclick = async () => {
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        if (outcome === 'accepted') {
            console.log('âœ… PWA installed');
            installBtn.remove();
        }
        deferredPrompt = null;
    };
    document.querySelector('.header').appendChild(installBtn);
});
</script>
</body>
</html>

<script src="https://apis.google.com/js/api.js"></script>
<script>
// â”€â”€â”€ Google Drive Sync â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const GDRIVE_CLIENT_ID = 'YOUR_CLIENT_ID.apps.googleusercontent.com'; // User needs to replace this
const GDRIVE_API_KEY = 'YOUR_API_KEY'; // User needs to replace this
const GDRIVE_SCOPES = 'https://www.googleapis.com/auth/drive.file';
const GDRIVE_FILENAME = 'tax-calculator-data.json';

let gdriveEnabled = false;
let gdriveFileId = null;
let gapiInited = false;
let gisInited = false;
let tokenClient;

function gapiLoaded() {
    gapi.load('client', initializeGapiClient);
}

async function initializeGapiClient() {
    await gapi.client.init({
        apiKey: GDRIVE_API_KEY,
        discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
    });
    gapiInited = true;
}

function gisLoaded() {
    tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: GDRIVE_CLIENT_ID,
        scope: GDRIVE_SCOPES,
        callback: '', // defined later
    });
    gisInited = true;
}

async function toggleGoogleDriveSync() {
    if (!gapiInited || !gisInited) {
        alert('âš ï¸ Google Drive API ×˜×•×¢×Ÿ... × ×¡×” ×©×•×‘ ×‘×¢×•×“ ×¨×’×¢');
        return;
    }

    if (!gdriveEnabled) {
        // Enable sync - request authorization
        tokenClient.callback = async (resp) => {
            if (resp.error !== undefined) {
                throw (resp);
            }
            gdriveEnabled = true;
            updateGDriveUI();
            await syncToGoogleDrive();
        };

        if (gapi.client.getToken() === null) {
            tokenClient.requestAccessToken({prompt: 'consent'});
        } else {
            tokenClient.requestAccessToken({prompt: ''});
        }
    } else {
        // Disable sync
        gdriveEnabled = false;
        const token = gapi.client.getToken();
        if (token !== null) {
            google.accounts.oauth2.revoke(token.access_token);
            gapi.client.setToken('');
        }
        updateGDriveUI();
    }
}

function updateGDriveUI() {
    const btn = document.getElementById('gdriveSyncBtn');
    const icon = document.getElementById('gdriveIcon');
    const status = document.getElementById('gdriveSyncStatus');
    
    if (gdriveEnabled) {
        btn.style.background = 'linear-gradient(135deg,#10b981,#059669)';
        icon.textContent = 'âœ…';
        status.textContent = 'ğŸ”„ ××¡×•× ×›×¨×Ÿ ×¢× Google Drive';
        status.style.display = 'block';
    } else {
        btn.style.background = 'linear-gradient(135deg,#3b82f6,#1d4ed8)';
        icon.textContent = 'â˜ï¸';
        status.style.display = 'none';
    }
}

async function syncToGoogleDrive() {
    if (!gdriveEnabled) return;
    
    try {
        const data = {
            saved: saved,
            settings: {
                VAT: VAT,
                advanceTaxPercent: advanceTaxPercent,
                homeOfficePercent: parseFloat(document.getElementById('homeOfficePercent').value)
            },
            timestamp: new Date().toISOString()
        };
        
        const content = JSON.stringify(data, null, 2);
        const blob = new Blob([content], { type: 'application/json' });
        
        // Check if file exists
        if (!gdriveFileId) {
            const searchResponse = await gapi.client.drive.files.list({
                q: `name='${GDRIVE_FILENAME}' and trashed=false`,
                fields: 'files(id, name)',
                spaces: 'drive'
            });
            
            if (searchResponse.result.files.length > 0) {
                gdriveFileId = searchResponse.result.files[0].id;
            }
        }
        
        const metadata = {
            name: GDRIVE_FILENAME,
            mimeType: 'application/json'
        };
        
        const form = new FormData();
        form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
        form.append('file', blob);
        
        const url = gdriveFileId 
            ? `https://www.googleapis.com/upload/drive/v3/files/${gdriveFileId}?uploadType=multipart`
            : 'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart';
        
        const method = gdriveFileId ? 'PATCH' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            headers: new Headers({ 'Authorization': 'Bearer ' + gapi.client.getToken().access_token }),
            body: form
        });
        
        const result = await response.json();
        gdriveFileId = result.id;
        
        const status = document.getElementById('gdriveSyncStatus');
        status.textContent = 'âœ… × ×©××¨ ×œ-Google Drive ×‘×”×¦×œ×—×”';
        setTimeout(() => {
            if (gdriveEnabled) status.textContent = 'ğŸ”„ ××¡×•× ×›×¨×Ÿ ×¢× Google Drive';
        }, 2000);
        
    } catch (error) {
        console.error('Google Drive sync error:', error);
        alert('âš ï¸ ×©×’×™××” ×‘×¡× ×›×¨×•×Ÿ ×¢× Google Drive');
    }
}

async function loadFromGoogleDrive() {
    if (!gdriveEnabled) return;
    
    try {
        const searchResponse = await gapi.client.drive.files.list({
            q: `name='${GDRIVE_FILENAME}' and trashed=false`,
            fields: 'files(id, name)',
            spaces: 'drive'
        const cats = period.cats || {};
        data.transport[idx] = cats['×ª×—×‘×•×¨×”'] || 0;
        data.office[idx] = cats['××©×¨×“'] || 0;
        data.equipment[idx] = cats['×¦×™×•×“ ××©×¨×“×™'] || 0;
        data.vehicle[idx] = cats['×¨×›×‘'] || 0;
        data.training[idx] = cats['×”×“×¨×›×”'] || 0;
        data.home[idx] = cats['×“×™×¨×”'] || 0;
    });

    // Calculate totals
    const totals = {};
    Object.keys(data).forEach(key => {
        totals[key] = data[key].reduce((a, b) => a + b, 0);
    });

    // Generate HTML
    const fmt = n => 'â‚ª' + Math.round(n).toLocaleString('he-IL');
    const currentDate = new Date().toLocaleDateString('he-IL', { year: 'numeric', month: 'long', day: 'numeric' });
    
    let html = `
    <div id="printableReport" style="font-family:Arial,sans-serif;direction:rtl;padding:2rem;">
        <div style="text-align:center;margin-bottom:2rem;border-bottom:3px solid #1a365d;padding-bottom:1rem;">
            <h1 style="color:#1a365d;margin:0;font-size:2rem;">ğŸ“Š ×“×•×— ×©× ×ª×™ - ××—×©×‘×•×Ÿ ××¡ ×•××¢"×</h1>
            <p style="color:#64748b;margin:0.5rem 0 0;">×ª××¨×™×š ×”×¤×§×”: ${currentDate}</p>
        </div>

        <table style="width:100%;border-collapse:collapse;font-size:0.85rem;">
            <thead>
                <tr style="background:#1a365d;color:white;">
                    <th style="padding:0.75rem;text-align:right;border:1px solid #cbd5e1;font-weight:700;width:15%;">×¡×¢×™×£</th>
                    ${periodNames.map(p => `<th style="padding:0.75rem;text-align:center;border:1px solid #cbd5e1;font-weight:700;width:12%;">${p}</th>`).join('')}
                    <th style="padding:0.75rem;text-align:center;border:1px solid #cbd5e1;font-weight:700;background:#0f172a;width:13%;">×¡×”"×› ×©× ×ª×™</th>
                </tr>
            </thead>
            <tbody>
    `;

    categories.forEach(cat => {
        if (cat.key === 'separator') {
            html += `<tr style="height:0.3rem;"><td colspan="8" style="background:${cat.color};border:none;"></td></tr>`;
            return;
        }

        const isBold = ['income', 'expenses', 'profit', 'vat', 'advTax'].includes(cat.key);
        const bgColor = isBold ? '#f8fafc' : 'white';
        
        html += `<tr style="background:${bgColor};">`;
        html += `<td style="padding:0.6rem;border:1px solid #e2e8f0;font-weight:${isBold ? '700' : '400'};color:${cat.color};">${cat.name}</td>`;
        
        data[cat.key].forEach(val => {
            html += `<td style="padding:0.6rem;border:1px solid #e2e8f0;text-align:center;font-weight:${isBold ? '600' : '400'};">${val > 0 ? fmt(val) : '-'}</td>`;
        });
        
        const totalVal = totals[cat.key];
        html += `<td style="padding:0.6rem;border:1px solid #e2e8f0;text-align:center;font-weight:700;background:#f1f5f9;color:${cat.color};">${totalVal > 0 ? fmt(totalVal) : '-'}</td>`;
        html += `</tr>`;
    });

    html += `
            </tbody>
        </table>

        <div style="margin-top:2rem;padding:1rem;background:#f8fafc;border-right:4px solid #1a365d;border-radius:8px;">
            <h3 style="margin:0 0 0.5rem;color:#1a365d;">ğŸ“Œ ×”×¢×¨×•×ª:</h3>
            <ul style="margin:0;padding-right:1.5rem;color:#64748b;line-height:1.8;">
                <li>×©×™×¢×•×¨ ××¢"×: ${(VAT * 100).toFixed(1)}%</li>
                <li>××—×•×– ××§×“××•×ª ××¡: ${(advanceTaxPercent * 100).toFixed(1)}%</li>
                <li>××—×•×– ×©×™××•×© ×¢×¡×§×™ ×‘×“×™×¨×”: ${document.getElementById('homeOfficePercent').value}%</li>
                <li>×“×•×— ×–×” × ×•×¦×¨ ××•×˜×•××˜×™×ª ×××¢×¨×›×ª ××—×©×‘×•×Ÿ ×”××¡</li>
            </ul>
        </div>

        <div style="margin-top:2rem;text-align:center;color:#94a3b8;font-size:0.8rem;border-top:1px solid #e2e8f0;padding-top:1rem;">
            ××—×©×‘×•×Ÿ ××¡ ×•××¢"× ××ª×§×“× | ×”×•×¤×§ ×‘-${currentDate}
        </div>
    </div>
    `;

    // Remove any existing print div
    const existing = document.getElementById('printableReport');
    if (existing) existing.remove();

    // Create temporary container
    const printDiv = document.createElement('div');
    printDiv.innerHTML = html;
    document.body.appendChild(printDiv);

    // Wait for content to be ready, then print
    setTimeout(() => {
        window.print();
        
        // Clean up after print dialog closes
        setTimeout(() => {
            const elem = document.getElementById('printableReport');
            if (elem) elem.remove();
        }, 500);
    }, 100);
}
</script>
